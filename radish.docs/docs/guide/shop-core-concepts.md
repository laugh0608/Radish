# 2. 核心概念

> 入口页：[商城系统设计方案](/guide/shop-system)

## 2.1 商品类型

商城支持多种商品类型，每种类型有不同的购买和使用逻辑。

### 2.1.1 商品类型枚举

```csharp
public enum ProductType
{
    /// <summary>
    /// 虚拟权益 - 购买后立即生效，有有效期
    /// 例如：专属徽章、头像框、称号、主题皮肤
    /// </summary>
    Benefit = 1,

    /// <summary>
    /// 虚拟消耗品 - 存入背包，使用时消耗
    /// 例如：改名卡、置顶卡、高亮卡、经验卡
    /// </summary>
    Consumable = 2,

    /// <summary>
    /// 实物商品 - 需要发货（暂不实现）
    /// 例如：周边、礼品
    /// </summary>
    Physical = 99
}
```

### 2.1.2 商品类型对比

| 类型 | 购买后行为 | 使用方式 | 有效期 | 示例 |
|------|-----------|---------|--------|------|
| 权益类 | 立即生效 | 自动生效 | 有 | 徽章、头像框、称号 |
| 消耗品 | 存入背包 | 手动使用 | 无/有 | 改名卡、置顶卡 |
| 实物 | 等待发货 | 收货使用 | 无 | 周边（暂不实现） |

### 2.1.3 商品类型详细说明

**权益类商品（Benefit）**：
- 购买后立即写入用户权益表
- 自动生效，无需手动操作
- 有明确的有效期（永久/限时）
- 同类型权益可叠加时长（如加成道具）
- 到期后自动失效

**消耗品商品（Consumable）**：
- 购买后存入用户背包
- 需要用户手动使用
- 使用后从背包移除
- 部分消耗品有使用期限（如 30 天内使用）
- 支持批量购买

---

## 2.2 权益类型

权益是用户购买商品后获得的实际效果。

### 2.2.1 权益类型枚举

```csharp
public enum BenefitType
{
    /// <summary>
    /// 专属徽章 - 显示在用户名旁
    /// </summary>
    Badge = 1,

    /// <summary>
    /// 头像框 - 装饰用户头像
    /// </summary>
    AvatarFrame = 2,

    /// <summary>
    /// 专属称号 - 显示在用户名下方
    /// </summary>
    Title = 3,

    /// <summary>
    /// 主题皮肤 - 个性化界面主题
    /// </summary>
    Theme = 4,

    /// <summary>
    /// 功能解锁 - 解锁特定功能
    /// </summary>
    FeatureUnlock = 5,

    /// <summary>
    /// 经验加成 - 经验值获取加成
    /// </summary>
    ExpBoost = 6,

    /// <summary>
    /// 萝卜币加成 - 萝卜币获取加成
    /// </summary>
    CoinBoost = 7
}
```

### 2.2.2 权益类型详细说明

| 权益类型 | 说明 | 展示位置 | 叠加规则 |
|---------|------|---------|---------|
| 专属徽章 | 身份标识 | 用户名旁 | 可同时拥有多个，选择展示 |
| 头像框 | 头像装饰 | 头像外圈 | 可同时拥有多个，选择展示 |
| 专属称号 | 个性称号 | 用户名下方 | 可同时拥有多个，选择展示 |
| 主题皮肤 | 界面主题 | 全局界面 | 可同时拥有多个，选择使用 |
| 功能解锁 | 特定功能 | 功能入口 | 不叠加 |
| 经验加成 | 经验 ×N | 经验获取时 | 可叠加，时长叠加 |
| 萝卜币加成 | 萝卜币 ×N | 萝卜币获取时 | 可叠加，时长叠加 |

### 2.2.3 加成道具说明

**经验加成**和**萝卜币加成**是临时性权益，通常通过购买加成道具获得：

| 加成类型 | 说明 | 效果参数示例 | 叠加规则 |
|---------|------|-------------|---------|
| 经验加成 | 一段时间内经验值获取加成 | `{"multiplier": 1.5, "hours": 24}` | 多个加成按时长叠加，效果取最高 |
| 萝卜币加成 | 一段时间内萝卜币获取加成 | `{"multiplier": 1.2, "hours": 24}` | 多个加成按时长叠加，效果取最高 |

---

## 2.3 消耗品类型

消耗品是一次性使用的道具。

### 2.3.1 消耗品类型枚举

```csharp
public enum ConsumableType
{
    /// <summary>
    /// 改名卡 - 修改用户昵称
    /// </summary>
    RenameCard = 1,

    /// <summary>
    /// 帖子置顶卡 - 置顶帖子 N 小时
    /// </summary>
    PostPinCard = 2,

    /// <summary>
    /// 帖子高亮卡 - 帖子标题高亮 N 小时
    /// </summary>
    PostHighlightCard = 3,

    /// <summary>
    /// 经验卡 - 立即获得 N 点经验值
    /// </summary>
    ExpCard = 4,

    /// <summary>
    /// 萝卜币红包 - 立即获得 N 萝卜币
    /// </summary>
    CoinCard = 5,

    /// <summary>
    /// 双倍经验卡 - N 小时内经验值 ×2
    /// </summary>
    DoubleExpCard = 6,

    /// <summary>
    /// 抽奖券 - 参与抽奖活动（预留）
    /// </summary>
    LotteryTicket = 99
}
```

### 2.3.2 消耗品详细说明

| 消耗品 | 使用效果 | 参数 | 使用限制 |
|--------|---------|------|---------|
| 改名卡 | 修改昵称一次 | - | 30 天内使用 |
| 帖子置顶卡 | 帖子置顶 | `hours: 24/48/72` | 仅限自己的帖子 |
| 帖子高亮卡 | 标题高亮 | `hours: 24/48/72` | 仅限自己的帖子 |
| 经验卡 | 获得经验值 | `exp: 100/500/1000` | 无限制 |
| 萝卜币红包 | 获得萝卜币 | `coins: 50/100/500` | 无限制 |
| 双倍经验卡 | 经验 ×2 | `hours: 1/6/24` | 不与其他加成叠加 |

---

## 2.4 订单状态

订单状态机定义了订单的生命周期。

### 2.4.1 订单状态枚举

```csharp
public enum OrderStatus
{
    /// <summary>
    /// 待支付 - 订单已创建，等待支付
    /// </summary>
    Pending = 0,

    /// <summary>
    /// 已支付 - 支付成功，等待发放权益
    /// </summary>
    Paid = 1,

    /// <summary>
    /// 已完成 - 权益已发放，订单完成
    /// </summary>
    Completed = 2,

    /// <summary>
    /// 已取消 - 用户取消或超时取消
    /// </summary>
    Cancelled = 3,

    /// <summary>
    /// 已退款 - 已退款（虚拟商品暂不支持）
    /// </summary>
    Refunded = 4,

    /// <summary>
    /// 发放失败 - 权益发放失败，需人工处理
    /// </summary>
    Failed = 5
}
```

### 2.4.2 订单状态流转

```
                    ┌──────────────┐
                    │   Pending    │ ← 创建订单
                    │    待支付    │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │  Cancelled   │ │     Paid     │ │   超时取消   │
    │   用户取消   │ │    已支付    │ │  (30分钟)    │
    └──────────────┘ └──────┬───────┘ └──────────────┘
                           │
                    ┌──────┴───────┐
                    │              │
                    ▼              ▼
             ┌──────────────┐ ┌──────────────┐
             │  Completed   │ │    Failed    │
             │    已完成    │ │   发放失败   │
             └──────────────┘ └──────┬───────┘
                                     │
                                     ▼
                              ┌──────────────┐
                              │   人工处理   │
                              │  重试/退款   │
                              └──────────────┘
```

### 2.4.3 状态转换规则

| 当前状态 | 可转换到 | 触发条件 |
|---------|---------|---------|
| Pending | Paid | 支付成功 |
| Pending | Cancelled | 用户取消 / 超时 30 分钟 |
| Paid | Completed | 权益发放成功 |
| Paid | Failed | 权益发放失败 |
| Failed | Completed | 人工重试成功 |
| Failed | Refunded | 人工退款 |

---

## 2.5 库存类型

商品库存分为无限库存和限量库存。

### 2.5.1 库存类型枚举

```csharp
public enum StockType
{
    /// <summary>
    /// 无限库存 - 不限制购买数量
    /// </summary>
    Unlimited = 0,

    /// <summary>
    /// 限量库存 - 有固定库存数量
    /// </summary>
    Limited = 1
}
```

### 2.5.2 库存管理规则

**无限库存**：
- 不需要库存扣减
- 适用于大部分虚拟商品
- 无超卖风险

**限量库存**：
- 需要并发控制
- 使用乐观锁防止超卖
- 支持库存预警
- 适用于限量版商品、活动商品

---

## 2.6 有效期类型

权益和消耗品都可能有有效期限制。

### 2.6.1 有效期类型枚举

```csharp
public enum DurationType
{
    /// <summary>
    /// 永久有效
    /// </summary>
    Permanent = 0,

    /// <summary>
    /// 固定天数（从购买/激活时开始计算）
    /// </summary>
    Days = 1,

    /// <summary>
    /// 固定到期时间（活动商品）
    /// </summary>
    FixedDate = 2
}
```

### 2.6.2 有效期计算规则

| 类型 | 计算方式 | 示例 |
|------|---------|------|
| 永久 | 无到期时间 | 永久徽章 |
| 固定天数 | 购买时间 + N 天 | 30 天经验加成 |
| 固定到期 | 指定日期 | 活动限定（2026-02-14 到期） |

**时长叠加规则**（同类型权益）：
- 如果当前有效：新到期时间 = 当前到期时间 + 新增天数
- 如果已过期：新到期时间 = 当前时间 + 新增天数

---

## 2.7 限购规则

限购机制防止用户囤积或刷单。

### 2.7.1 限购类型

```csharp
public class PurchaseLimit
{
    /// <summary>
    /// 每人限购数量（0 = 不限）
    /// </summary>
    public int PerUserLimit { get; set; }

    /// <summary>
    /// 每人每日限购数量（0 = 不限）
    /// </summary>
    public int PerUserDailyLimit { get; set; }

    /// <summary>
    /// 总量限制（0 = 不限，与库存不同，这是销售目标）
    /// </summary>
    public int TotalLimit { get; set; }

    /// <summary>
    /// 最低等级要求（0 = 不限）
    /// </summary>
    public int MinLevelRequired { get; set; }
}
```

### 2.7.2 限购检查顺序

```
1. 检查商品是否上架
2. 检查用户等级是否满足
3. 检查库存是否充足
4. 检查总量限制
5. 检查每人限购
6. 检查每日限购
7. 检查用户余额
```

---

## 2.8 商品分类

商品分类用于组织和展示商品。

### 2.8.1 预设分类

| 分类 ID | 分类名称 | 说明 | 排序 |
|--------|---------|------|------|
| badge | 徽章装饰 | 徽章、头像框、称号 | 1 |
| card | 功能卡片 | 改名卡、置顶卡等 | 2 |
| boost | 加成道具 | 经验卡、双倍卡等 | 3 |
| theme | 主题皮肤 | 界面主题、特效 | 4 |
| limited | 限定商品 | 限量版、活动商品 | 5 |
| other | 其他 | 未分类商品 | 99 |

### 2.8.2 分类数据结构

```csharp
public class ProductCategory
{
    public string Id { get; set; }           // 分类 ID
    public string Name { get; set; }         // 分类名称
    public string? Icon { get; set; }        // 分类图标
    public string? Description { get; set; } // 分类描述
    public int SortOrder { get; set; }       // 排序权重
    public bool IsEnabled { get; set; }      // 是否启用
}
```

---

> 下一篇：[3. 商品管理](/guide/shop-product)
