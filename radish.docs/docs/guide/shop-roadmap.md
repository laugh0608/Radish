# 8. 实施计划

> 入口页：[商城系统设计方案](/guide/shop-system)

## 8.1 实施概览

### 8.1.1 里程碑定位

商城系统作为 Radish 项目的 **M9 里程碑**，预计在完成以下前置条件后开始实施：

**前置依赖**：
- ✅ M1: 基础架构（已完成）
- ✅ M2: 认证授权（已完成）
- ✅ M3: 用户系统（已完成）
- ✅ M7: 萝卜币系统（已完成）
- ✅ M8: 经验值系统（已完成）

**并行依赖**：
- M6: 论坛系统（消耗品需要）
- M10: 通知系统（购买通知）

### 8.1.2 实施策略

**分阶段交付**：
- **P1 阶段**：核心购买流程（商品、订单、支付）
- **P2 阶段**：权益系统（VIP、徽章、消耗品）
- **P3 阶段**：前端页面（商城首页、订单、背包）
- **P4 阶段**：管理功能（商品管理、统计报表）

**增量发布**：
- 每个阶段完成后独立发布
- 通过功能开关控制可见性
- 灰度测试后全量开放

---

## 8.2 阶段划分

### 8.2.1 P1 阶段：核心购买流程

**目标**：实现基本的商品购买流程

**任务清单**：

**后端**：
- [x] 创建数据库表
  - [x] `ShopProduct` - 商品表
  - [x] `ShopProductCategory` - 商品分类表
  - [x] `ShopOrder` - 订单表
  - [x] 添加索引
- [x] 实现实体模型
  - [x] `Product.cs` - 商品实体
  - [x] `ProductCategory.cs` - 商品分类实体
  - [x] `Order.cs` - 订单实体
  - [x] 枚举类型（ProductType, OrderStatus 等）
- [x] 实现 Repository 层
  - [x] 使用 `IBaseRepository<Product>` 泛型仓储
  - [x] 使用 `IBaseRepository<ProductCategory>` 泛型仓储
  - [x] 使用 `IBaseRepository<Order>` 泛型仓储
- [x] 实现 Service 层
  - [x] `IProductService` / `ProductService`
    - [x] 商品 CRUD
    - [x] 商品列表查询
    - [x] 库存扣减（乐观锁）
  - [x] `IOrderService` / `OrderService`
    - [x] 创建订单
    - [x] 订单查询
    - [x] 订单状态管理
  - [x] 限购检查逻辑（集成在 ProductService.CheckCanBuyAsync）
- [x] 实现 Controller 层
  - [x] `ShopController` - 用户端商城接口
  - [x] 订单接口（集成在 ShopController）
- [x] 集成萝卜币系统
  - [x] 余额查询
  - [x] 支付扣款
  - [x] 退款（预留）
- [x] AutoMapper 配置
  - [x] `ShopProfile` - 商城模块映射
- [x] 种子数据
  - [x] 初始商品分类（5 个分类）
  - [x] 初始商品（11 个商品：徽章、头像框、称号、功能卡片、加成道具）

**测试**：
- [ ] 单元测试
  - [ ] ProductService 测试
  - [ ] OrderService 测试
  - [ ] 库存并发测试
  - [ ] 限购检查测试
- [ ] API 测试
  - [ ] 商品列表查询
  - [ ] 商品详情查询
  - [ ] 创建订单
  - [ ] 订单列表查询

**验收标准**：
- [x] 用户可以查看商品列表和详情
- [x] 用户可以成功购买商品并扣除萝卜币
- [x] 库存正确扣减，不会超卖
- [x] 限购规则正确生效
- [x] 订单记录完整保存

**预计工作量**：3-4 天

---

### 8.2.2 P2 阶段：权益系统

**目标**：实现权益发放和管理

**任务清单**：

**后端**：
- [x] 创建数据库表
  - [x] `ShopUserInventory` - 用户背包表
  - [x] `ShopUserBenefit` - 用户权益表
  - [x] 添加索引
- [x] 实现实体模型
  - [x] `UserInventory.cs` - 用户背包实体
  - [x] `UserBenefit.cs` - 用户权益实体
  - [x] 枚举类型（ConsumableType, BenefitType 等）
- [x] 实现 Repository 层
  - [x] 使用 `IBaseRepository<UserInventory>` 泛型仓储
  - [x] 使用 `IBaseRepository<UserBenefit>` 泛型仓储
- [x] 实现 Service 层
  - [x] `IUserInventoryService` / `UserInventoryService`
    - [x] 背包查询
    - [x] 道具使用
    - [x] 道具数量管理
  - [x] `IUserBenefitService` / `UserBenefitService`
    - [x] 权益发放
    - [x] 权益查询
    - [x] 权益激活/取消激活
- [x] 实现 Controller 层
  - [x] 背包接口（集成在 ShopController）
  - [x] 权益接口（集成在 ShopController）
- [x] 集成经验值系统
  - [x] 经验卡使用
- [x] 集成通知系统
  - [x] 购买成功通知
- [ ] 定时任务
  - [ ] 订单超时取消任务
  - [ ] 权益过期检查任务
- [x] 消耗品效果实现
  - [x] 改名卡
  - [x] 帖子置顶卡（框架已实现，待论坛系统集成）
  - [x] 帖子高亮卡（框架已实现，待论坛系统集成）
  - [x] 经验卡
  - [x] 萝卜币红包
  - [x] 双倍经验卡（框架已实现，待 buff 系统集成）

**测试**：
- [ ] 单元测试
  - [ ] UserInventoryService 测试
  - [ ] UserBenefitService 测试
  - [ ] 权益发放测试
  - [ ] 消耗品使用测试
- [ ] 集成测试
  - [ ] 完整购买流程测试（创建订单 → 支付 → 发放权益）

**验收标准**：
- [x] 购买商品后权益正确发放到背包
- [x] 权益时长可以正确叠加
- [x] 消耗品可以正确使用并产生效果
- [ ] 过期权益自动失效
- [ ] 超时订单自动取消

**预计工作量**：3-4 天

---

### 8.2.3 P3 阶段：前端页面 ✅ 已完成

**目标**：实现商城前端页面

**任务清单**：

**前端**：
- [x] 创建项目结构
  - [x] `/src/apps/shop` - 商城应用目录
  - [x] `/src/apps/order` - 订单应用目录
  - [x] `/src/apps/inventory` - 背包应用目录
- [x] API 请求层
  - [x] `shopApi.ts` - 商城 API (@radish/ui)
- [x] 页面实现
  - [x] `ShopHome.tsx` - 商城首页（商品分类导航 + 商品列表）
  - [x] `OrderList.tsx` - 订单列表
  - [x] `OrderDetail.tsx` - 订单详情
  - [x] `Inventory.tsx` - 我的背包（权益 + 消耗品）
- [x] 组件实现
  - [x] `PurchaseModal` - 购买确认弹窗（独立组件）
  - [x] 商品卡片 - 内联在 ProductList/ProductDetail 中
  - [x] 分类导航 - 内联在 ProductList 中
  - [x] 订单项 - 内联在 OrderList 中
  - [x] 道具使用弹窗 - 内联在 Inventory 中
- [x] 样式实现
  - [x] `ShopHome.module.scss` - 商城首页样式
  - [x] `OrderList.module.scss` - 订单列表样式
  - [x] `Inventory.module.scss` - 背包样式
  - [x] 响应式设计
- [x] WebOS 集成
  - [x] 注册商城应用（mdi:store）
  - [x] 注册订单应用（mdi:receipt）
  - [x] 注册背包应用（mdi:bag-personal）
  - [x] 配置窗口大小（1000x700）

**测试**：
- [ ] 组件测试
  - [ ] ProductCard 测试
  - [ ] OrderItem 测试
  - [ ] BenefitItem 测试
- [ ] 页面测试
  - [ ] 商城首页加载测试
  - [ ] 商品列表分页测试
  - [ ] 购买流程端到端测试

**验收标准**：
- ✅ 商城首页展示推荐商品和分类
- ✅ 商品列表支持筛选和排序
- ✅ 购买流程流畅，成功后跳转正确
- ✅ 订单列表展示完整，支持状态筛选
- ✅ 背包正确展示权益和消耗品
- ✅ 消耗品可以正常使用
- ✅ 响应式布局在不同屏幕下正常

**实际工作量**：2 天（2026-01-13 至 2026-01-14）

---

### 8.2.4 P4 阶段：管理功能 ⚠️ 后端已完成

**目标**：实现商城管理后台

**任务清单**：

**后端**：
- [x] 管理员接口（集成在 ShopController）
  - [x] 商品管理
    - [x] `AdminGetProducts` - 管理员获取商品列表
    - [x] `CreateProduct` - 创建商品
    - [x] `UpdateProduct` - 更新商品
    - [x] `DeleteProduct` - 删除商品（软删除）
  - [x] 订单管理
    - [x] `AdminGetOrders` - 订单列表（管理员视角）
    - [x] `AdminRetryFailedOrder` - 重试失败订单
  - [x] 统计功能
    - [x] `GetProductStats` - 商品销售统计
    - [x] `GetOrderStats` - 订单统计

**前端（Console）**：
- [ ] 商品管理页面
  - [ ] 商品列表
  - [ ] 创建/编辑商品表单
  - [ ] 商品上下架操作
  - [ ] 库存管理
- [ ] 订单管理页面
  - [ ] 订单列表（支持搜索和筛选）
  - [ ] 订单详情
  - [ ] 重试失败订单
- [ ] 统计报表页面
  - [ ] 销售概览
  - [ ] 商品销售排行
  - [ ] 订单趋势图表

**测试**：
- [ ] 管理功能测试
  - [ ] 商品 CRUD 测试
  - [ ] 订单管理测试
  - [ ] 统计数据准确性测试

**验收标准**：
- ✅ 管理员可以创建、编辑、删除商品（后端 API）
- ✅ 管理员可以查看订单并重试失败订单（后端 API）
- ✅ 统计报表数据准确（后端 API）
- ⏳ 管理界面友好易用（前端待实现）

**实际工作量**：1 天（后端 API，2026-01-13）
**待实现**：前端管理界面（radish.console）

---

## 8.3 技术风险与对策

### 8.3.1 高并发库存扣减

**风险**：
- 限量商品可能出现超卖问题
- 高并发下乐观锁冲突频繁，性能下降

**对策**：
- ✅ 使用乐观锁（StockVersion）防止超卖
- ✅ 乐观锁冲突时自动重试（最多 5 次，指数退避）
- ⚠️ 考虑引入 Redis 分布式锁（如果并发量大）
- ⚠️ 考虑使用消息队列削峰（如果并发量极大）

### 8.3.2 订单一致性

**风险**：
- 支付成功但权益发放失败
- 库存扣减失败但萝卜币已扣除

**对策**：
- ✅ 使用 `[UseTran]` 事务特性确保原子性
- ✅ 权益发放失败时订单状态标记为 `Failed`，支持人工重试
- ✅ 库存扣减失败时自动回滚萝卜币
- ✅ 完整的日志记录，便于问题排查

### 8.3.3 权益过期处理

**风险**：
- 权益过期检查不及时
- 过期权益未清理影响查询性能

**对策**：
- ✅ 定时任务每小时检查一次过期权益
- ✅ 查询时实时检查并更新过期状态
- ✅ 过期权益软删除（不物理删除）
- ⚠️ 考虑定期归档历史数据

### 8.3.4 消耗品使用安全

**风险**：
- 重复使用消耗品
- 消耗品效果未正确执行

**对策**：
- ✅ 使用数量扣减，确保不会重复使用
- ✅ 消耗品使用加事务保证
- ✅ 使用失败时不扣减数量
- ✅ 记录使用日志，可追溯

---

## 8.4 测试计划

### 8.4.1 单元测试

**测试范围**：
- Service 层核心逻辑
- 库存扣减逻辑
- 限购检查逻辑
- 权益发放逻辑
- 消耗品使用逻辑

**测试框架**：
- xUnit
- Moq（模拟依赖）

**测试覆盖率目标**：
- Service 层：>= 80%
- 核心逻辑：>= 90%

### 8.4.2 集成测试

**测试场景**：
- 完整购买流程（商品查询 → 购买 → 支付 → 权益发放）
- 并发购买限量商品（测试超卖）
- 权益叠加逻辑
- 消耗品使用流程

**测试工具**：
- Postman / REST Client
- 自动化测试脚本

### 8.4.3 压力测试

**测试场景**：
- 限量商品抢购（100 人同时购买 10 件商品）
- 商品列表查询性能（1000 QPS）
- 订单查询性能（500 QPS）

**性能目标**：
- 接口响应时间：P95 < 500ms
- 库存扣减无超卖
- 系统稳定性：无崩溃、无死锁

### 8.4.4 端到端测试

**测试流程**：
1. 用户注册并登录
2. 查看商城首页
3. 浏览商品列表
4. 查看商品详情
5. 购买商品（成功/失败场景）
6. 查看订单列表
7. 查看订单详情
8. 查看背包权益
9. 使用消耗品
10. 装备徽章/头像框

---

## 8.5 部署计划

### 8.5.1 数据库迁移

```bash
# 1. 备份数据库
dotnet run --project Radish.Api -- db:backup

# 2. 执行迁移脚本
dotnet ef database update --project Radish.Api

# 3. 验证表结构
dotnet run --project Radish.Api -- db:verify
```

### 8.5.2 种子数据初始化

```bash
# 初始化商品分类和初始商品
dotnet run --project Radish.Api -- seed:shop
```

### 8.5.3 配置更新

```json
{
  "Features": {
    "Shop": {
      "Enabled": true,
      "MaxPurchaseQuantity": 100,
      "OrderTimeoutMinutes": 30,
      "StockWarningThreshold": 10
    }
  }
}
```

### 8.5.4 定时任务配置

```csharp
// Program.cs
builder.Services.AddQuartz(q =>
{
    // 订单超时取消任务（每 5 分钟）
    q.AddJob<OrderTimeoutJob>(j => j.WithIdentity("OrderTimeoutJob"))
        .AddTrigger(t => t
            .ForJob("OrderTimeoutJob")
            .WithSimpleSchedule(s => s.WithIntervalInMinutes(5).RepeatForever()));

    // 权益过期检查任务（每小时）
    q.AddJob<InventoryExpirationJob>(j => j.WithIdentity("InventoryExpirationJob"))
        .AddTrigger(t => t
            .ForJob("InventoryExpirationJob")
            .WithSimpleSchedule(s => s.WithIntervalInHours(1).RepeatForever()));

    // 库存预警任务（每天 09:00）
    q.AddJob<StockWarningJob>(j => j.WithIdentity("StockWarningJob"))
        .AddTrigger(t => t
            .ForJob("StockWarningJob")
            .WithCronSchedule("0 0 9 * * ?"));
});
```

### 8.5.5 灰度发布

**阶段 1**：内部测试（1-2 天）
- 仅管理员可见
- 验证核心功能

**阶段 2**：小范围测试（3-5 天）
- 开放给 10% 用户
- 收集反馈和 Bug

**阶段 3**：全量发布
- 开放给所有用户
- 监控系统稳定性

---

## 8.6 监控与运维

### 8.6.1 关键指标监控

**业务指标**：
- 每日订单量
- 每日 GMV（总交易额）
- 订单成功率
- 权益发放成功率
- 热销商品排行

**技术指标**：
- API 响应时间
- 错误率
- 库存扣减冲突率
- 数据库连接数
- 缓存命中率

### 8.6.2 告警规则

**紧急告警**（短信 + 电话）：
- 订单成功率 < 95%
- 权益发放失败率 > 5%
- API 错误率 > 1%
- 数据库连接池耗尽

**警告告警**（企业微信）：
- 限量商品库存 < 10
- 订单失败数 > 10/小时
- API 响应时间 P95 > 1s

### 8.6.3 日志策略

**关键操作日志**：
- 订单创建/支付/完成
- 权益发放
- 库存扣减
- 消耗品使用

**错误日志**：
- 订单创建失败
- 权益发放失败
- 库存扣减冲突
- 支付失败

**日志级别**：
- `Information`: 正常操作
- `Warning`: 可恢复的错误（如乐观锁冲突）
- `Error`: 不可恢复的错误（如权益发放失败）

---

## 8.7 后续优化方向

### 8.7.1 功能扩展

**优惠券系统**（M11）：
- 满减券
- 折扣券
- 兑换码
- 优惠叠加规则

**购物车**（M12）：
- 支持批量购买
- 购物车持久化
- 优惠计算

**限时活动**（M13）：
- 限时折扣
- 秒杀活动
- 团购拼单

**社交功能**：
- 好友赠送
- 礼物系统
- 分享返利

### 8.7.2 性能优化

**缓存优化**：
- Redis 缓存热门商品
- Redis 缓存用户 VIP 状态
- CDN 加速商品图片

**数据库优化**：
- 读写分离
- 分库分表（订单表按月分表）
- 历史数据归档

**架构优化**：
- 引入消息队列（订单异步处理）
- 引入搜索引擎（商品搜索）
- 引入 ElasticSearch（订单搜索）

### 8.7.3 体验优化

**智能推荐**：
- 基于用户等级推荐
- 基于购买历史推荐
- 协同过滤推荐

**个性化**：
- 商品展示顺序个性化
- 推荐商品个性化
- 促销信息个性化

**流程优化**：
- 一键购买
- 购买历史快速复购
- 愿望清单

---

## 8.8 总结

### 8.8.1 预计工作量

| 阶段 | 任务内容 | 预计工作量 | 关键产出 |
|------|---------|----------|---------|
| P1 | 核心购买流程 | 3-4 天 | 商品、订单、支付 |
| P2 | 权益系统 | 3-4 天 | 背包、VIP、消耗品 |
| P3 | 前端页面 | 4-5 天 | 商城 UI |
| P4 | 管理功能 | 3-4 天 | 管理后台 |
| 测试 | 全面测试 | 2-3 天 | 测试报告 |
| 部署 | 上线发布 | 1-2 天 | 生产环境 |
| **总计** | - | **16-22 天** | 完整商城系统 |

### 8.8.2 关键成功因素

1. **扎实的基础系统**：萝卜币、经验值、通知系统必须稳定可靠
2. **并发安全**：库存扣减、订单创建必须保证数据一致性
3. **完善的测试**：单元测试、集成测试、压力测试覆盖全面
4. **良好的监控**：关键指标监控到位，问题及时发现
5. **灰度发布**：分阶段发布，降低风险

### 8.8.3 风险提示

- ⚠️ **技术复杂度**：并发控制、事务管理需要仔细设计
- ⚠️ **系统依赖**：依赖多个子系统，需要做好联调
- ⚠️ **数据一致性**：订单、支付、权益发放必须保证一致性
- ⚠️ **性能压力**：限量商品抢购可能带来瞬时高并发

### 8.8.4 下一步行动

1. 评审本设计文档，确认技术方案
2. 创建 GitHub Issue，分解任务
3. 启动 P1 阶段开发
4. 每日 Stand-up 同步进度
5. 完成一个阶段后立即测试和 Review

---

> 参考文档：
> - [2. 核心概念](/guide/shop-core-concepts)
> - [3. 商品管理](/guide/shop-product)
> - [4. 订单系统](/guide/shop-order)
> - [5. 权益系统](/guide/shop-inventory)
> - [6. 后端设计](/guide/shop-backend)
> - [7. 前端设计](/guide/shop-frontend)

---

> 本文档为商城系统的实施指南，随开发进度持续更新。如有变更请同步修改 [更新日志](/changelog/)。
