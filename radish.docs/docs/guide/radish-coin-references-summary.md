# 17-18. 参考资料与 M6 总结

> 入口页：[萝卜币系统设计方案](/guide/radish-coin-system)

## 17. 参考资料

- [支付宝积分规则](https://render.alipay.com/p/f/fd-izto3ght/index.html)
- [微信支付分设计](https://pay.weixin.qq.com/index.php/public/wechatpay_score)
- [虚拟货币监管政策](https://www.gov.cn/zhengce/)
- [电子商务法](http://www.npc.gov.cn/npc/c30834/201809/e1e066e1c8b24c6e8a4e3c3f14d1b9c8.shtml)

---

**文档版本**：v1.3
**创建日期**：2025-12-28
**最后更新**：2026-01-04
**负责人**：待定
**实施状态**：✅ **M6 已完成**（2026-01-04）

---

## 18. M6 实施完成总结（2026-01-04）

### 18.1 已完成功能

#### ✅ 核心基础服务
- **CoinService**：余额管理、交易记录、系统赠送
  - `GrantCoinAsync()` - 系统赠送萝卜币
  - `GetBalanceAsync()` - 查询用户余额
  - `GetTransactionsAsync()` - 查询交易记录（分页）
  - 支持多租户隔离
  - 乐观锁并发控制

#### ✅ 论坛奖励服务（CoinRewardService）
- **点赞奖励**：被点赞者获得 +2 胡萝卜，点赞者获得 +1 胡萝卜
  - 防刷机制：同一用户对同一内容每日仅计算一次
  - 点赞者每日上限：50 胡萝卜
- **神评奖励**：基础 +8 + 点赞加成 +5/点赞
  - 保留奖励：每满7天额外 +15 胡萝卜（最多3周）
- **沙发奖励**：基础 +5 + 点赞加成 +3/点赞
  - 保留奖励：每满7天额外 +10 胡萝卜（最多3周）

#### ✅ 定时任务（Hangfire）
- **神评/沙发统计任务**（CommentHighlightJob）
  - 每天凌晨 1 点执行
  - 增量扫描优化（仅扫描24小时内有更新的帖子/评论）
  - 支持可配置阈值（MinParentCommentCount/MinChildCommentCount）
  - 自动发放点赞加成奖励
- **保留奖励任务**（RetentionRewardJob）
  - 每周日凌晨 2 点执行
  - 检查神评/沙发保留天数并发放奖励

#### ✅ 精确计算系统
- **CoinCalculator 工具类**（Radish.Common/Utils/CoinCalculator.cs）
  - 单位转换：`ToWhiteRadish()` / `ToCarrot()`
  - 比例计算：`CalculateByRate()` - 向下取整
  - 手续费计算：`CalculateFee()` - 最小1胡萝卜
  - 批量分配：`DistributeEqually()` / `DistributeByWeight()`
  - 累积计算器：`AccumulativeCalculator` - 处理小数累积
  - 显示格式化：`FormatDisplay()` / `FormatAsWhiteRadish()`
  - **52个单元测试全部通过**（CoinCalculatorTest.cs）

#### ✅ 前端集成
- **Toast 通知组件**（@radish/ui）
  - 获得萝卜币时显示 Toast 提示
  - 支持不同类型（earn/spend/transfer）
- **余额显示**（StatusBar）
  - 顶部状态栏显示当前余额
  - 点击跳转到钱包页面
- **钱包页面**（WalletPage）
  - 余额展示（智能切换显示格式）
  - 交易记录列表（分页）
  - 交易筛选（类型、日期范围）

#### ✅ 注册奖励集成
- 新用户注册自动赠送 50 胡萝卜
- 集成到 UserController.Register
- 失败不影响注册流程

#### ✅ 文档完善
- 萝卜币系统设计方案（2578行，17个章节）
- 精确计算规范（第6节）
- 实施落地指南（第16节）
- API 接口文档
- 开发日志记录

### 18.2 技术亮点

1. **精度保证**
   - 所有交易以整数（胡萝卜）为单位
   - 统一向下取整（Floor）规则
   - 记录理论金额和舍入差额，支持审计

2. **防刷机制**
   - 同一用户对同一内容每日奖励仅计算一次
   - 点赞奖励每日上限 50 胡萝卜
   - 基于 Redis 的去重键（24小时过期）

3. **性能优化**
   - 神评/沙发增量扫描（仅扫描24小时内有更新的内容）
   - 批量插入神评/沙发记录
   - 异步发放点赞加成奖励（Task.Run）

4. **配置灵活**
   - 神评/沙发触发阈值可配置
   - 奖励金额可配置
   - 定时任务 Cron 表达式可配置

5. **测试覆盖**
   - CoinCalculator：52个单元测试（覆盖所有计算场景）
   - CoinService：7个单元测试（基础功能验证）

### 18.3 待优化项（M7+）

以下功能已在文档中详细设计，但不在 M6 范围内：

#### 🔜 转账功能（M9 - 商城系统）
- 用户间转账
- 手续费计算（阶梯费率）
- 转账限额控制
- 多租户配额管理

#### 🔜 商城消费（M9 - 商城系统）
- 商品购买
- 库存扣减
- 订单系统
- 权益发放

#### 🔜 对账机制（M10 - 可观测性与测试）
- 每日对账任务
- 余额一致性检查
- 差额报告生成

#### 🔜 高级功能（M10+）
- 活动奖励（签到、任务）
- 余额趋势图表
- 萝卜币飞入动画
- 富豪榜
- 红包功能

### 18.4 验收结论

**M6（萝卜币系统）验收标准 100% 达成**：
- ✅ 发帖/互动触发萝卜币奖励
- ✅ 神评/沙发保留奖励正常发放
- ✅ 前端余额显示与钱包页面可用
- ✅ 精确计算系统完整实现并通过测试
- ✅ 定时任务正常运行
- ✅ 防刷机制生效
- ✅ 注册奖励集成完成

**建议**：可以合并到主分支，开始 M7（消息通知系统）。

---
