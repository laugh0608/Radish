# 3. 经验值获取机制

> 入口页：[经验值与等级系统设计方案](/guide/experience-level-system)

## 3.1 互动奖励规则

| 行为 | 获得方 | 奖励经验值 | 每日上限 | 说明 |
|------|--------|-----------|---------|------|
| **发布帖子** | 作者 | +10 经验值 | 50 经验值(5 篇) | 鼓励内容创作 |
| **发布评论** | 作者 | +2 经验值 | 20 经验值(10 条) | 促进讨论互动 |
| **被点赞(帖子)** | 作者 | +5 经验值 | 100 经验值(20 次) | 内容质量认可 |
| **被点赞(评论)** | 作者 | +3 经验值 | 60 经验值(20 次) | 优质评论奖励 |
| **给他人点赞** | 点赞者 | +1 经验值 | 10 经验值(10 次) | 鼓励良性互动 |
| **成为神评** | 评论者 | +50 经验值 | 200 经验值(4 次) | 神评成就奖励 |
| **成为沙发** | 评论者 | +20 经验值 | 80 经验值(4 次) | 沙发成就奖励 |
| **被回复(评论)** | 评论者 | +3 经验值 | 30 经验值(10 次) | 引发讨论奖励 |
| **首次登录(日)** | 用户 | +5 经验值 | 5 经验值(1 次) | 签到奖励 |
| **连续登录(周)** | 用户 | +20 经验值 | 20 经验值(1 次) | 连续 7 天登录 |

**经验值计算原则**:
- **高质量内容优先**:被点赞奖励 > 发布奖励
- **互动优先于创作**:评论被回复 > 单纯发评论
- **成就奖励丰厚**:神评/沙发一次性奖励高于日常互动
- **每日上限防刷**:避免用户通过大量低质量内容刷经验

## 3.2 防刷机制

### 3.2.1 每日上限控制

**实现方式**:
```
缓存 Key: exp:daily:{userId}:{action_type}:{date}
Value: 今日该行为已获得的经验值
TTL: 次日凌晨
```

**示例**:
```csharp
// 检查每日上限
var todayExpKey = $"exp:daily:{userId}:post_like:{DateTime.Today:yyyyMMdd}";
var todayExp = await _cache.GetAsync<int>(todayExpKey);

if (todayExp >= 100) // 被点赞每日上限 100
{
    return; // 不再奖励
}

// 增加经验值并更新缓存
await GrantExperienceAsync(userId, 5, "被点赞");
await _cache.IncrementAsync(todayExpKey, 5, TimeSpan.FromHours(24));
```

### 3.2.2 去重规则

**同一行为不重复奖励**:
- 同一用户对同一帖子的点赞,仅奖励作者一次(取消点赞不扣除)
- 同一用户对同一评论的点赞,仅奖励作者一次
- 同一评论成为神评/沙发,仅奖励一次(失去地位不扣除)

**实现方式**:
```sql
-- 在 exp_transaction 表中使用唯一键防止重复
UNIQUE INDEX idx_dedup (user_id, exp_type, business_type, business_id, created_date)
```

### 3.2.3 异常检测

**检测规则**:
- 短时间内大量发帖(1 小时内超过 20 篇)
- 短时间内大量点赞(1 分钟内超过 50 次)
- 互刷行为检测(两个账号频繁互相点赞/评论)

**处理策略**:
- 第一次:警告并冻结经验值获取 24 小时
- 第二次:冻结经验值获取 7 天
- 第三次:永久禁止经验值获取,等级降至 Lv.0

## 3.3 初始经验值

- **新用户注册**:初始 0 经验值,等级 Lv.0
- **完善资料**:+10 经验值(头像、简介、兴趣标签)
- **首次发帖**:+20 经验值(鼓励新用户参与)
- **首次评论**:+10 经验值

---
