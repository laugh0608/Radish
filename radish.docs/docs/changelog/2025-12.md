# 2025年12月开发日志

> OIDC 认证中心与前端框架搭建

## 2025.12.14

- **feat(client)**: 将 Console 应用改为在新标签页打开
  - **架构决策**：经过深入分析，确认 Console 不应嵌入 WebOS iframe
  - **技术限制**：
    - OIDC 认证流程在 iframe 中无法正常工作（无法处理 redirect_uri 回调）
    - 复杂路由系统会与 WebOS 路由冲突
    - Gateway 路径剥离导致 Console 路径识别混乱
  - **架构优势**：
    - 关注点分离：Client 面向普通用户，Console 面向管理员
    - 权限隔离：管理功能不应与用户功能混在同一代码库
    - 部署灵活性：Console 可部署到内网，Client 部署到公网
    - 代码体积控制：避免普通用户加载管理功能代码
  - **实现方式**：
    - 新增 `external` 应用类型，在新标签页打开外部链接
    - 更新 `windowStore.openApp` 方法，识别 external 类型并调用 `window.open`
    - 简化 OIDC 回调路径判断逻辑，统一使用 `/callback`
  - **提交**：`feat: 将 Console 应用改为在新标签页打开并简化路径处理` (a893cfc)

- **docs**: 完善前端应用架构决策文档
  - **CLAUDE.md**：
    - 添加"Application Architecture Decision"章节
    - 说明三种应用集成方式（内置/嵌入/外部）的选择标准
    - 详细解释为什么不合并 Console 到 Client
  - **FrontendDesign.md**：
    - 新增第 10.4 节"应用集成架构决策"
    - 10.4.1：三种应用类型的选择标准对照表
    - 10.4.2：详细分析 Console 无法嵌入的技术限制和架构理由
    - 10.4.3：应用集成最佳实践和决策流程
  - **DevelopmentSpecifications.md**：
    - 更新项目结构约定，明确 radish.client、radish.console、radish.ui 的定位
    - 完善分层依赖约定，说明前端项目的独立性
  - **DevelopmentFramework.md**：
    - 更新前端技术栈描述，列出所有前端项目
    - 重构分层视图，展示 Gateway 统一入口和前端项目结构
  - **AppRegistry.tsx & types.ts**：
    - 添加详细的文档注释，说明三种应用集成方式
    - 为 `AppDefinition.type` 字段添加完整说明

## 2025.12.12

- **test(api)**: 完善 ClientController 测试并启用跳过的测试用例
  - 完善 OpenIddictApplicationManager mock 实现,正确返回 FakeClient 属性
  - 修复 CreateAsync 返回值类型 (从 ValueTask 改为 ValueTask<object>)
  - 启用之前跳过的 5 个测试用例 (GetClients、CreateClient、DeleteClient、ResetClientSecret 等)
  - 所有测试通过,验证客户端管理 API 的核心功能

- **feat(auth)**: 完善 OIDC Claim 映射机制
  - **实现基于 scope 的动态 claim destination 分配**:
    - 新增 `GetClaimDestinations` 方法,根据请求的 scope 决定 claim 包含在 id_token 还是 access_token 中
    - sub claim: 始终在 access_token 中,如果请求了 openid scope 则也在 id_token 中
    - name claim: 始终在 access_token 中,如果请求了 openid 或 profile scope 则也在 id_token 中
    - email claim: 始终在 access_token 中,如果请求了 email scope 则也在 id_token 中
    - role claim: 始终在 access_token 中,如果请求了 profile scope 则也在 id_token 中
    - tenant_id: 仅在 access_token 中 (业务相关,不泄露到客户端)
  - **登录时添加更多标准 OIDC claims**:
    - 添加 email claim (如果用户有邮箱)
    - 添加 preferred_username 和 given_name claims
    - 同时设置 ClaimTypes 和 OpenIddictConstants 版本的 claims,确保兼容性
  - **注册 email scope**: 在 OpenIddict 服务器配置中添加 email scope
  - **优势**:
    - 符合 OIDC 规范: ID Token 和 Access Token 职责分离
    - 优化 Token 大小: 客户端只获取需要的信息
    - 提升安全性: 敏感信息 (如 tenant_id) 不会泄露到客户端
    - 灵活性: 支持不同客户端按需请求不同的用户信息

- **docs(auth)**: 添加基于 Scope 的动态 Claim Destination 分配文档
  - 新增 AuthenticationGuide.md 第 8.4 节,详细说明 OIDC Claim 映射机制
  - 记录 GetClaimDestinations 方法的设计原则和实现细节
  - 添加 Claim Destination 规则表格
  - 补充登录时设置的 Claims 列表
  - 说明支持的 Scopes 及其用途 (openid, profile, email, offline_access, radish-api)
  - 提供不同场景下的使用示例 (最小权限、身份认证、完整信息)
  - 修正章节编号 (9-16 章)

## 2025.12.11（续）

- **feat(client/webos-shell)**: 实现 WebOS Desktop Shell 与通用组件库
  - **核心功能**：
    - 桌面系统：状态栏、桌面图标网格、Dock 栏、窗口管理器
    - 窗口系统：支持拖拽（react-rnd）、调整大小、最小化、关闭、`z-index` 自动管理
    - 应用系统：应用注册表、基于角色的权限控制、欢迎应用
    - 状态管理：Zustand 实现窗口状态（windowStore）和用户状态（userStore）
  - **通用组件库**（CSS Modules 实现）：
    - 基础组件：Button（3 种变体、3 种尺寸）、Icon（`@iconify/react` 封装）
    - 桌面组件：GlassPanel（毛玻璃面板，3 种模糊强度）
    - 桌面小部件：AppIcon（应用图标）、DesktopWindow（可拖拽窗口）
  - **组件展示页面**：ComponentShowcase 用于预览所有 UI 组件
  - **技术实现**：
    - CSS Modules 实现样式隔离，避免全局污染
    - TypeScript 路径别名配置（`@/*` 映射到 `src/*`）
    - Vite 配置优化（移除 https: false 避免类型错误）
    - 完整的类型定义（AppDefinition、WindowState、UserInfo）
  - **项目结构**：
    - `src/desktop/`: Shell、StatusBar、Desktop、Dock、WindowManager、AppRegistry
    - `src/apps/welcome/`: 欢迎应用（展示用户信息和使用指南）
    - `src/widgets/`: AppIcon、DesktopWindow
    - `src/stores/`: windowStore、userStore
    - `src/shared/ui/`: 通用 UI 组件库（base/ 和 desktop/）
  - **访问方式**：
    - `/` - WebOS Desktop Shell（默认）
    - `/?showcase` - 组件库展示页面
    - `/?demo` - 原有的 OIDC Demo 页面
  - **文件变更**：新增 37 个文件，修改 5 个配置文件

- **docs(client)**: 重构文档结构，文档归档到 radish.docs
  - 将 `COMPONENTS.md` 移至 `radish.docs/docs/ComponentLibrary.md`
  - 将 `QUICKSTART.md` 移至 `radish.docs/docs/WebOSQuickStart.md`
  - 更新 `radish.client/README.md` 为简洁版本，指向详细文档
  - 统一文档管理：所有详细文档集中在 radish.docs 项目

## 2025.12.11

- **fix(auth/client-info)**: 修复登录页面无法显示客户端信息的问题
  - **问题现象**：访问登录页时始终显示"未知的客户端"，即使 URL 中包含正确的 `client_id` 参数
  - **根本原因**：
    - `TryGetClientIdFromReturnUrl` 方法中错误使用 `Uri.UnescapeDataString` 对整个 URL 解码
    - 解码后 `redirect_uri` 参数中的 `https://localhost:5000` 被提取出来，导致 `Uri` 类解析器无法识别查询字符串
    - 示例：`/connect/authorize?client_id=radish-client&redirect_uri=https%3A%2F%2Flocalhost%3A5000` 解码后变成 `/connect/authorize?client_id=radish-client&redirect_uri=https://localhost:5000`，`Uri.Query` 返回空字符串
  - **解决方案**：
    - 移除 `Uri.UnescapeDataString` 调用，改用 `IndexOf('?')` 和 `Substring` 直接提取查询字符串
    - 使用 `QueryHelpers.ParseQuery` 解析（会自动处理 URL 编码的参数值）
    - 添加 `ClientSummaryViewModel.FromStoreData` 方法，支持从 OpenIddict 默认实体的 Properties 字典中提取扩展属性
  - **客户端扩展属性完善**（`OpenIddictSeedHostedService.cs`）：
    - 为所有客户端添加 `description` 和 `developerName` 属性（存储在 OpenIddict Properties 字典中）
    - `radish-client`：描述为"Radish 社区平台前端应用"
    - `radish-scalar`：描述为"Radish API 文档和调试工具"
    - `radish-console`：描述为"Radish 后台管理控制台"
    - `radish-shop`：描述为"Radish 商城应用（占位，未来实现）"
    - 更新逻辑确保现有客户端也能自动补充扩展属性
  - **日志优化**：将调试日志从 `Console.WriteLine` 改为 `Serilog`，使用 `Log.Debug` 记录解析过程，`Log.Warning` 记录客户端不存在等异常情况
  - **技术说明**：
    - OpenIddict 默认使用 EF Core 实体存储，扩展信息需存储在 `Properties: ImmutableDictionary<string, JsonElement>` 中
    - URL 解析时不应对整个 URL 解码，避免嵌套 URL 参数（如 `redirect_uri`）干扰查询字符串识别
  - **文件变更**：
    - `Radish.Auth/ViewModels/Account/LoginViewModel.cs`: 添加 `FromStoreData` 和 `GetPropertyFromDictionary` 方法
    - `Radish.Auth/Controllers/AccountController.cs`: 修复 URL 解析逻辑并添加 Serilog 日志
    - `Radish.Auth/OpenIddict/OpenIddictSeedHostedService.cs`: 为客户端添加扩展属性
    - `Radish.Auth/Radish.Auth.csproj`: 添加 `OpenIddict.Abstractions` NuGet 包引用

## 2025.12.09

- **chore(auth/openiddict)**: 移除尚未接入的自定义 SqlSugar Store，并确认继续采用 EF Core 存储
  - 删除 `Radish.Auth/OpenIddict/Stores` 下的临时实现（RadishApplicationStore/RadishAuthorizationStore/RadishScopeStore/RadishTokenStore）及 `OpenIddictSqlSugarExtensions`，避免误导
  - 保留 `Radish.Model/OpenIddict/*` 实体，继续作为客户端管理 API 的 DTO/视图模型来源
  - `Radish.Auth/Program.cs` 仍通过 `AuthOpenIddictDbContext` + SQLite (`DataBases/RadishAuth.OpenIddict.db`) 持久化 OpenIddict 数据；Api 项目仅共享 `IOpenIddictApplicationManager` 访问该库
  - 在 DevelopmentPlan/AuthenticationGuide 中更新说明：Auth 负责 OpenIddict 数据库的创建与迁移，Api 只消费，不再计划切换 SqlSugar Store

## 2025.12.08

- **feat(log)**: 统一日志输出到解决方案根目录
  - **问题**：每个项目（Api、Auth、Gateway）都在自己的目录下生成 Log 文件夹，分散且不便管理
  - **解决方案**：修改 Serilog 配置，统一输出到解决方案根目录的 `Log/` 文件夹
    - `Radish.Common/LogTool/LogContextTool.cs`：
      - 新增 `GetSolutionLogDirectory()`：向上查找 .slnx/.sln 文件定位解决方案根目录
      - 新增 `GetProjectName()`：从 .csproj 文件自动识别当前项目名称
      - `BaseLogs` 改为动态计算的解决方案根目录路径
      - 添加 `ProjectName` 静态属性用于区分不同项目
    - `Radish.Extension/SerilogExtension/LogConfigExtension.cs`：
      - 修改日志路径包含项目名称：`Log/{ProjectName}/Log.txt`、`Log/{ProjectName}/AopSql/AopSql.txt`
    - `Radish.Extension/SerilogExtension/SerilogSetup.cs`：
      - Serilog 内部调试日志路径：`Log/{ProjectName}/SerilogDebug/Serilog{date}.txt`
  - **新的日志结构**：
    ```
    Log/
    ├── Radish.Api/
    │   ├── Log20251208.txt
    │   ├── AopSql/AopSql20251208.txt
    │   └── SerilogDebug/Serilog20251208.txt
    ├── Radish.Gateway/...
    └── Radish.Auth/...
    ```
  - **优势**：所有项目日志集中管理，便于查看和归档；自动识别项目名称，无需手动配置

- **feat(dbmigrate)**: seed 命令自动检测并初始化表结构
  - **问题**：用户直接运行 `seed` 时，如果表不存在会报错 `no such table: Role`
  - **解决方案**：
    - `Radish.DbMigrate/Program.cs`：
      - `RunSeedAsync` 中添加表结构检查，使用 `db.DbMaintenance.IsAnyTable("Role", false)` 检测
      - 如果表不存在，自动执行 `RunInitAsync` 创建表结构
      - 优化输出信息，添加状态标识（✓ 和 ⚠️）
    - `start.ps1` 和 `start.sh`：
      - 更新 DbMigrate 菜单说明，默认命令改为 `seed`（更常用）
      - 添加命令说明：init - 仅初始化表结构；seed - 智能初始化（自动检测表结构）
  - **优势**：简化操作流程，新用户只需运行 `seed` 即可完成所有初始化，无需先 `init` 再 `seed`

## 2025.12.07

- **feat(i18n/unified-language-codes)**: 统一前后端语言代码为 zh 和 en
  - **问题背景**：
    - 前端 i18next 使用 `en` 和 `zh-CN`
    - Auth 后端配置了 `zh-CN`、`en`、`en-US`
    - API 后端配置了 `zh-CN`、`zh-Hans`、`en`、`en-US`
    - 资源文件命名不一致：`Errors.zh-CN.resx`、`Errors.zh-Hans.resx`、`Errors.en-US.resx`
    - 导致前端传递 `en` 时后端无法匹配，回退到默认中文
  - **解决方案**：统一使用中性语言代码 `zh` 和 `en`
    - 前端（`radish.client`）：
      - `i18n.ts`：将 `zh-CN` 改为 `zh`，更新 `fallbackLng` 和 `supportedLngs`
      - `App.tsx`：所有语言相关代码统一使用 `zh` 和 `en`（语言切换、URL 参数、Accept-Language 等）
    - Auth 项目（`Radish.Auth`）：
      - `Program.cs`：`SupportedCultures` 只保留 `zh` 和 `en`
      - `AuthorizationController.cs`：在重定向到登录页时提取 culture 参数，确保语言参数在登录页 URL 上而非 ReturnUrl 内
      - `Login.cshtml`：语言切换按钮改为 `zh` 和 `en`
      - 资源文件：删除 `Errors.zh-CN.resx` 和 `Errors.en-US.resx`，重命名为 `Errors.zh.resx` 和 `Errors.en.resx`
    - API 项目（`Radish.Api`）：
      - `Program.cs`：`SupportedCultures` 只保留 `zh` 和 `en`
      - 资源文件：删除 `Errors.zh-CN.resx`、`Errors.zh-Hans.resx`、`Errors.en-US.resx`，只保留 `Errors.zh.resx` 和 `Errors.en.resx`
  - **中间件顺序修复**（`Radish.Auth/Program.cs`）：
    - 将 `UseRequestLocalization` 移到 `UseRouting` 之前，确保在路由和控制器执行前设置 Culture
    - 修复前：`UseStaticFiles → UseRouting → UseCors → UseRequestLocalization`（❌ Culture 设置太晚）
    - 修复后：`UseStaticFiles → UseRequestLocalization → UseRouting → UseCors`（✅ 正确顺序）
  - **优势**：
    - 前后端语言代码完全一致，无需映射转换
    - 简洁明了，避免 zh-CN/zh-Hans/en-US/en 混乱
    - 资源文件结构清晰：`Errors.resx`（默认）、`Errors.zh.resx`、`Errors.en.resx`
    - 保留扩展性：未来可按需添加 `zh-TW`（繁体中文）、`en-GB`（英式英语）等

## 2025.12.06

- **feat(api/client-management)**: 实现 OIDC 客户端管理 API
  - **ClientController**（`Radish.Api/Controllers/ClientController.cs`）：
    - 实现完整的 CRUD API：`GetClients`（分页+搜索）、`GetClient`、`CreateClient`、`UpdateClient`、`DeleteClient`、`ResetClientSecret`
    - 使用 `IOpenIddictApplicationManager` 直接操作 OpenIddict 数据库
    - 软删除实现：使用 OpenIddict Properties 字段存储 `IsDeleted`、`CreatedAt/By`、`UpdatedAt/By`、`DeletedAt/By`
    - 所有接口需要 `System` 或 `Admin` 角色权限（`[Authorize(Roles = "System,Admin")]`）
    - API 路由遵循项目规范：`/api/v1/Client/[action]`
  - **数据模型**（`Radish.Model/ViewModels/Client/`）：
    - `ClientVo`：客户端视图模型（列表和详情）
    - `CreateClientDto`：创建客户端请求 DTO
    - `UpdateClientDto`：更新客户端请求 DTO
    - `ClientSecretVo`：客户端密钥返回模型（仅在创建/重置时返回一次）
  - **分页模型**（`Radish.Model/PageModel.cs`）：
    - 新增通用分页模型 `PageModel<T>`，包含 `Page`、`PageSize`、`DataCount`、`PageCount`、`Data`
  - **项目依赖**（`Radish.Api/Radish.Api.csproj`）：
    - API 项目新增对 Auth 项目的引用，以共享 `AuthOpenIddictDbContext`
    - API 和 Auth 项目共享同一个 OpenIddict 数据库

- **refactor(database/unified-path)**: 统一所有数据库文件到 DataBases 文件夹
  - **OpenIddict 数据库共享**（`Radish.Api/Program.cs` + `Radish.Auth/Program.cs`）：
    - 两个项目通过查找 `Radish.slnx` 文件定位解决方案根目录
    - 默认数据库路径：`{SolutionRoot}/DataBases/RadishAuth.OpenIddict.db`
    - Auth 项目启动时创建数据库并初始化种子数据
    - API 项目通过 `IOpenIddictApplicationManager` 访问同一数据库
  - **SqlSugar 数据库路径**（`Radish.Common/DbTool/BaseDbConfig.cs`）：
    - 修改 `SpecialDbString` 方法，SQLite 数据库自动存储到 `{SolutionRoot}/DataBases/`
    - 新增 `FindSolutionRoot()` 方法，通过查找 `Radish.slnx` 定位解决方案根目录
    - 配置文件中只需填写文件名（如 `Radish.db`），路径自动拼接
  - **最终数据库布局**：
    ```
    Radish/
    └── DataBases/
        ├── Radish.db                    # API 主数据库（SqlSugar）
        ├── RadishLog.db                 # API 日志数据库（SqlSugar）
        └── RadishAuth.OpenIddict.db     # OpenIddict 数据库（EF Core，Auth + API 共享）
    ```

- **refactor(docs/folder-rename)**: 重命名根目录 docs 文件夹为 Docs
  - 将 `docs/` 重命名为 `Docs/`，与 `radish.docs/` 区分
  - 更新 `README.md`、`CLAUDE.md`、`AGENTS.md` 中的相关引用
  - `Docs/` 作为文档入口，提供跳转链接到 `radish.docs/docs/` 的实际文档内容

- **feat(scalar+auth/oidc-integration)**: Scalar API 文档集成 OIDC 认证，优化 Auth 服务配置
  - **Scalar OAuth2 配置**（`Radish.Extension/OpenApiExtension/ScalarSetup.cs`）：
    - 在 OpenAPI 文档中添加 OAuth2 Security Scheme，定义 Authorization Code Flow
    - 配置 Scalar UI 的 OAuth2 认证：`AddPreferredSecuritySchemes("oauth2")` + `AddOAuth2Flows`
    - 设置 `ClientId="radish-scalar"`，`RedirectUri="https://localhost:5000/scalar/oauth2-callback"`
    - 默认 Scopes：`openid`、`profile`、`radish-api`
    - 修复服务器列表显示问题：清空默认列表，添加 Gateway HTTPS/HTTP + API 直连三个选项
  - **Auth Server Scopes 注册**（`Radish.Auth/Program.cs`）：
    - 添加 `options.RegisterScopes("openid", "profile", "offline_access", "radish-api")`
    - 解决 `invalid_scope` 错误：OpenIddict Server 必须显式注册允许使用的 scopes
  - **客户端授权类型调整**（`Radish.Auth/OpenIddict/OpenIddictSeedHostedService.cs`）：
    - 将 `radish-scalar` 的 `ConsentType` 从 `Implicit` 改为 `Explicit`
    - 现在每次授权都会显示授权确认页面，方便测试和调试
  - **使用方式**：
    1. 访问 `https://localhost:5000/scalar`（通过 Gateway）
    2. 点击右上角 **Authenticate** 按钮
    3. 选择 **oauth2** 认证方式，点击 **Authorize**
    4. 使用测试账号登录（用户名：`test`，密码：`P@ssw0rd!`）
    5. 确认授权后，所有 API 请求自动携带 Bearer Token

- **docs(auth+database)**: 更新认证和数据库文档
  - **AuthenticationGuide.md**：
    - 更新第 4.4 节"客户端动态管理"：详细说明软删除和审计字段的实现
    - 更新管理 API 表格：使用实际的 API 路由（`/api/v1/Client/*`）
    - 更新创建客户端示例：使用实际的请求/响应格式
    - 新增第 13 章"数据库配置"：详细说明 OpenIddict 和 SqlSugar 数据库的配置方式
    - 新增第 14 章"Scalar API 文档集成"：详细说明 OIDC 认证配置和使用方式

## 2025.12.03

- **feat(gateway+client/oidc-through-gateway)**: 通过 Gateway 打通 Auth + Api + 前端的完整 OIDC 授权码链路
  - `Radish.Api/Radish.Api.oidc.http` 增补"6. （推荐）全量通过 Gateway 的 OIDC 测试流程"，统一使用 `https://localhost:5000` 作为 OIDC 入口（登录 / 授权码 / 换取 Token / 当前用户接口）。
  - `Radish.Gateway/appsettings.Local.json` 中为 `/Account/{**catch-all}` 与 `/connect/{**catch-all}` 新增 `auth-account-route` / `auth-connect-route`，将 OIDC 相关端点通过 Gateway 转发到 `Radish.Auth`，前端与 `.http` 示例均不再直连 5200 端口。
  - `radish.client/src/App.tsx` 新增最小 OIDC Demo：
    - 在首页"Authentication" 区块提供"通过 OIDC 登录"与"退出登录"按钮，登录走 `GET {apiBaseUrl}/connect/authorize`，退出调用 `POST {apiBaseUrl}/Account/Logout` 并清理 `localStorage` 中的 access_token/refresh_token。
    - 实现 `OidcCallback` 回调组件，处理 `/oidc/callback?code=xxx`，调用 `POST {apiBaseUrl}/connect/token` 换取 Token，持久化到 `localStorage` 后跳转回首页。
    - 首页挂载时通过 `GET {apiBaseUrl}/api/v1/User/GetUserByHttpContext` 拉取当前用户信息，并在界面显示 `userId/userName/tenantId`，验证 Auth ↔ Api ↔ Db 的映射配置。
  - 前端增加轻量级 `apiFetch` 封装，统一附带 `Accept: application/json` 与可选的 Authorization 头，为后续 WebOS 子应用复用网关 API 提供最小示例。

- **fix(dbmigrate/role-permission)**: 记录 `RoleModulePermission` 表缺失导致本地 SQLite 抛出 `SQLite Error 1: 'no such table: RoleModulePermission'` 时的推荐修复路径
  - 建议在本地环境遇到该错误时执行：
    - `dotnet run --project Radish.DbMigrate/Radish.DbMigrate.csproj -- init`
    - `dotnet run --project Radish.DbMigrate/Radish.DbMigrate.csproj -- seed`
  - `init` 通过 `CodeFirst.InitTables` 为所有实体（包含 `RoleModulePermission`）建表，`seed` 则按约定灌入 System/Admin 与 `GetUserByHttpContext` 相关的角色权限种子数据，确保权限表结构与数据与当前 OIDC/Auth 策略保持一致。

- **docs(auth+gateway+frontend)**: 同步认证与 Gateway 文档，标记当前实现状态
  - `AuthenticationGuide.md` 中说明当前仓库已在 `radish.client/src/App.tsx` 中实现一套通过 Gateway 的极简 OIDC 流程，本节其余 `oidc-client-ts/react-oidc-context` 内容为后续正式接入方案。
  - `GatewayPlan.md` Phase 0 验收标准中补充"通过 Gateway 反向代理 Radish.Auth 的 `/Account` 与 `/connect` 端点"，明确本地 OIDC 调试入口统一为 Gateway (`https://localhost:5000`)。
  - `FrontendDesign.md` 在 M4 迭代计划中说明：当前仍暂时保留 `src/App.tsx` 作为 WeatherForecast + Gateway OIDC 登录/退出的 Demo 页，未来将由 WebOS 桌面 Shell 取代。

## 2025.12.02

- **feat(auth+api/oidc-minimal)**: 打通 Radish.Auth 与 Radish.Api 的最小 OIDC 授权码 + 资源服务器链路
  - 在 `Radish.Auth` 中接入 OpenIddict EF Core 集成：
    - 新增 `AuthOpenIddictDbContext`（/Radish.Auth/OpenIddict/AuthOpenIddictDbContext.cs），专门承载 OpenIddict 的 Application/Authorization/Scope/Token 实体，使用 Sqlite 本地文件 `RadishAuth.OpenIddict.db`
    - `Program.cs` 中通过 `AddDbContext<AuthOpenIddictDbContext>()` + `.AddOpenIddict().AddCore().UseEntityFrameworkCore().UseDbContext<AuthOpenIddictDbContext>()` 正式启用 EF Core 存储
    - 启动时调用 `db.Database.EnsureCreated()` 自动建表
  - 配置 OpenIddict Server 仅对 access_token 使用签名 JWT，不再加密：
    - 使用 `options.AddDevelopmentEncryptionCertificate().AddDevelopmentSigningCertificate()` 配置开发环境的加密/签名证书
    - 调用 `options.DisableAccessTokenEncryption()`，保留内部票据（授权码/RefreshToken）的加密，但 access_token 统一发出 3 段 JWS，方便 `Radish.Api` 通过 `JwtBearer` 验签
    - Issuer 从配置读取：`OpenIddict:Server:Issuer = http://localhost:5200`，与本地 Auth 服务地址保持一致
  - 落地最小可用 OIDC 控制器：
    - `AccountController`（/Radish.Auth/Controllers/AccountController.cs）
      - `GET /Account/Login`：返回极简 HTML 表单，预填测试账号 `test / P@ssw0rd!`，方便浏览器直接登录
      - `POST /Account/Login`：校验固定账号，写入 Cookie 认证会话，Claims 中包含 `sub=1`、`name=test`、`role=System`
    - `AuthorizationController`（/Radish.Auth/Controllers/AuthorizationController.cs）
      - `~/connect/authorize`：
        - 未登录 → 通过 Cookie 认证方案 `Challenge` 到 `/Account/Login?returnUrl=...`
        - 已登录 → 从 `HttpContext.GetOpenIddictServerRequest()` 读取 client_id、redirect_uri、scope 等信息
        - 构造 `ClaimsPrincipal`，确保存在 `sub`，然后 `principal.SetScopes(request.GetScopes())` + `SetResources("radish-api")`，交给 OpenIddict 生成授权码
    - `UserInfoController`：实现 `~/connect/userinfo` 基于当前用户 Claims 返回基本信息（sub/name/role 等）
  - 种子数据（Scope + Client）：
    - `OpenIddictSeedHostedService`（/Radish.Auth/OpenIddict/OpenIddictSeedHostedService.cs）：
      - Scope：`radish-api`（Name=radish-api，Resources=["radish-api"]）
      - Client：`radish-client`：
        - ClientId="radish-client"，DisplayName="Radish Web Client"
        - RedirectUris=["https://localhost:5000/oidc/callback"], PostLogoutRedirectUris=["https://localhost:5000"]
        - Permissions：Authorization Endpoint、Token Endpoint、AuthorizationCode、RefreshToken、ResponseTypes.Code、`scope:radish-api`
        - 移除强制 PKCE 要求（便于目前手工使用 `.http` 调试），后续前端接入后再根据需要重新开启
  - `Radish.Api` 作为资源服务器信任 `Radish.Auth` 发出的 access_token：
    - `Program.cs`（/Radish.Api/Program.cs）：
      - 配置 JwtBearer：
        - `options.Authority = "http://localhost:5200";`
        - 暂不设置 `Audience`，并在 `TokenValidationParameters` 中关闭 `ValidateAudience`，只验证签名 + 时效：
          ```csharp
          options.TokenValidationParameters = new TokenValidationParameters
          {
              ValidateIssuer = true,
              ValidateAudience = false,
              ValidateLifetime = true,
              ValidateIssuerSigningKey = true,
              ClockSkew = TimeSpan.Zero
          };
          ```
        - `options.RequireHttpsMetadata = false`（本地使用 http 调试，后续通过 Gateway 暴露 https）
      - 中间件顺序：`app.UseAuthentication();` 在 `UseAuthorization()` 之前，确保 JWT 认证实际生效
    - 授权策略：
      - `Client` 策略改为基于 `scope=radish-api` 控制访问资源服务器：
        ```csharp
        .AddPolicy("Client", policy =>
            policy.RequireClaim("scope", "radish-api").Build())
        ```
  - 用于验证链路的调试接口与 .http 脚本：
    - `UserController.GetUserByHttpContext`（/Radish.Api/Controllers/UserController.cs）
      - 控制器级别：`[Authorize]`（只要求已认证）
      - 方法级别：`[Authorize(Policy = "Client")]`，只要 access_token 里有 `scope=radish-api` 即可访问
      - 从 `IHttpContextUser` 读取 `UserId/UserName/TenantId` 并返回，目前由于 Claim 映射仍按旧 JWT 方案实现，返回的是 `0/""/0`，后续单独补齐映射逻辑
    - 新增 `Radish.Api/Radish.Api.oidc.http`，用于手动验证整个 OIDC 流程：
      1. 浏览器访问 `http://localhost:5200/Account/Login`，使用 `test / P@ssw0rd!` 登录
      2. 浏览器访问 `http://localhost:5200/connect/authorize?response_type=code&client_id=radish-client&redirect_uri=https%3A%2F%2Flocalhost%3A5000%2Foidc%2Fcallback&scope=radish-api`，从回调 URL 中复制 `code`
      3. 使用 `.http` 中的 `POST http://localhost:5200/connect/token` 请求，用 `grant_type=authorization_code&client_id=radish-client&code=...&redirect_uri=...` 换取 access_token（为 3 段 JWT）
      4. 在 `.http` 中使用 `Authorization: Bearer {access_token}` 调用 `GET http://localhost:5100/api/v1/User/GetUserByHttpContext`，确认返回 200 表示 Auth+Api 最小 OIDC 流程已经打通

## 2025.12.01

- **feat(auth/project)**: 创建 Radish.Auth OIDC 认证服务器项目
  - 集成 OpenIddict 7.2.0 框架，配置 OIDC 标准端点（/connect/authorize、/connect/token、/connect/userinfo、/connect/introspect、/connect/revoke）
  - 配置服务端口 `http://localhost:5200`（内部端口，对外通过 Gateway 暴露）
  - 支持三种授权流程：Authorization Code Flow（授权码流程）、Refresh Token Flow（刷新令牌）、Client Credentials Flow（客户端凭证）
  - 配置开发/生产环境密钥管理：开发环境使用临时密钥，生产环境强制使用固定加密密钥
  - 集成 Cookie 认证（用于登录页面会话管理）
  - 完整的配置文件模板：appsettings.json、appsettings.Local.example.json
  - WorkId 约定：Auth 服务使用 WorkId=2（API=0, Gateway=1, Auth=2）
- **feat(auth/models)**: 创建 OIDC 数据模型与 ViewModels
  - 新增 `UserClaim` 实体：存储 OIDC 声明和自定义用户声明
  - 新增 OpenIddict 自定义实体（位于 `Radish.Model/Models/OpenIddict/`）：
    - `RadishApplication`：OAuth 客户端应用管理，包含状态（Active/Disabled/PendingReview）和类型（Internal/ThirdParty）枚举
    - `RadishAuthorization`：用户授权记录
    - `RadishScope`：OAuth 作用域定义
    - `RadishToken`：令牌存储（access_token、refresh_token、authorization_code）
  - 对应的 ViewModels：UserClaimVo、VoOidcApp、VoOidcAuth、VoOidcScope、VoOidcToken
  - AutoMapper 映射配置：`OidcProfile.cs`，特殊处理 ClientSecret 隐私保护和 PayloadPreview 截断
- **feat(auth/startup)**: 完成 Program.cs 配置
  - Autofac 容器集成（AutofacModuleRegister + AutofacPropertyModuleReg）
  - Serilog 日志配置（AppSettingsTool 前置注册）
  - SqlSugar ORM + Snowflake ID 配置
  - Redis/内存缓存切换支持
  - CORS 跨域配置（允许 Gateway、前端、文档等来源）
  - OpenIddict Server 端点透传（EnableAuthorizationEndpointPassthrough、EnableTokenEndpointPassthrough、EnableUserInfoEndpointPassthrough）
  - 开发环境禁用 HTTPS 要求（DisableTransportSecurityRequirement）
  - 启动日志输出（与 API/Gateway 风格统一）
- **chore(auth/test)**: 验证项目编译和启动
  - 编译成功，无警告和错误
  - 服务成功启动在 http://localhost:5200
  - 日志输出正常，显示监听地址和 CORS 配置
- **plan(auth/next)**: 规划 Auth 项目后续工作（按优先级）
  1. 创建 OIDC 端点控制器（AuthorizationController、TokenController、UserInfoController、AccountController）
  2. 实现 OpenIddict 自定义 SqlSugar Store（替代当前的内存存储，支持生产环境持久化）（2025.12.09 更新：本计划已取消，统一改为长期使用 EF Core `AuthOpenIddictDbContext`）
  3. 创建 Radish.DbSeed 项目（数据库初始化、预注册 OIDC 客户端：radish-client、radish-scalar、radish-console、radish-shop）
  4. 实现客户端管理 API（CRUD 接口管理 OIDC 客户端应用）
  5. 配置 Radish.Api 为资源服务器（添加 JWT Bearer 验证，从 Auth 服务验证访问令牌）
  6. 前端集成（WebOS 前端对接 OIDC 登录流程）
