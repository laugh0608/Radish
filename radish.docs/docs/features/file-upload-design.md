# æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° Radish é¡¹ç›®çš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å­˜å‚¨æ–¹æ¡ˆé€‰å‹ã€ä¸Šä¼ æ–¹å¼å¯¹æ¯”ã€å®‰å…¨æ€§è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ç­‰å†…å®¹ã€‚

**ç›®æ ‡**ï¼š
- ğŸ¯ æ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ç­‰å¤šç§æ–‡ä»¶ç±»å‹ä¸Šä¼ 
- ğŸ”’ ç¡®ä¿ä¸Šä¼ å®‰å…¨æ€§å’Œæ•°æ®å®Œæ•´æ€§
- âš¡ ä¼˜åŒ–ä¸Šä¼ æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
- ğŸ—ï¸ æ˜“äºæ‰©å±•å’Œç»´æŠ¤çš„æ¶æ„è®¾è®¡

**é€‚ç”¨åœºæ™¯**ï¼š
- è®ºå›å¸–å­é…å›¾
- ç”¨æˆ·å¤´åƒä¸Šä¼ 
- è¯„è®ºé™„ä»¶
- æ–‡æ¡£åˆ†äº«
- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å›¾ç‰‡æ’å…¥

---

## ğŸ“¦ å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ 1ï¼šæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨

**é€‚ç”¨åœºæ™¯**ï¼šå°å‹é¡¹ç›®ã€å¼€å‘æµ‹è¯•ç¯å¢ƒ

#### ä¼˜ç‚¹
- âœ… **å®ç°ç®€å•**ï¼šæ— éœ€é¢å¤–æœåŠ¡ï¼Œä»£ç ç›´æ¥æ“ä½œæ–‡ä»¶ç³»ç»Ÿ
- âœ… **é›¶æˆæœ¬**ï¼šä¸éœ€è¦ä»˜è´¹ï¼Œåªå ç”¨æœåŠ¡å™¨ç£ç›˜ç©ºé—´
- âœ… **è®¿é—®é€Ÿåº¦å¿«**ï¼šå±€åŸŸç½‘æˆ–æœ¬æœºè®¿é—®ï¼Œå»¶è¿Ÿä½
- âœ… **å®Œå…¨å¯æ§**ï¼šæ–‡ä»¶å®Œå…¨åœ¨è‡ªå·±æŒæ§ä¹‹ä¸‹ï¼Œæ— ç¬¬ä¸‰æ–¹ä¾èµ–
- âœ… **è°ƒè¯•æ–¹ä¾¿**ï¼šå¯ç›´æ¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼Œä¾¿äºå¼€å‘è°ƒè¯•

#### ç¼ºç‚¹
- âŒ **æ‰©å±•æ€§å·®**ï¼šå•æœºå­˜å‚¨å®¹é‡æœ‰é™ï¼Œç£ç›˜æ»¡äº†éœ€è¦æ‰‹åŠ¨æ‰©å®¹
- âŒ **ä¸æ”¯æŒåˆ†å¸ƒå¼**ï¼šå¤šæœåŠ¡å™¨éƒ¨ç½²æ—¶ï¼Œæ–‡ä»¶ä¸èƒ½å…±äº«
- âŒ **å¤‡ä»½å®¹ç¾å¤æ‚**ï¼šéœ€è¦è‡ªå·±å®ç°å¤‡ä»½ç­–ç•¥å’Œå®¹ç¾æ–¹æ¡ˆ
- âŒ **æ—  CDN åŠ é€Ÿ**ï¼šéœ€è¦é¢å¤–é…ç½® Nginx åå‘ä»£ç† + CDN
- âŒ **ç£ç›˜æ•…éšœé£é™©**ï¼šç¡¬ç›˜æŸåå¯èƒ½å¯¼è‡´æ–‡ä»¶ä¸¢å¤±
- âŒ **å¸¦å®½é™åˆ¶**ï¼šå¤§é‡ä¸‹è½½ä¼šå ç”¨æœåŠ¡å™¨å¸¦å®½

#### ç›®å½•ç»“æ„è®¾è®¡
```
DataBases/Uploads/
â”œâ”€â”€ Images/                    # å›¾ç‰‡æ–‡ä»¶
â”‚   â”œâ”€â”€ 2025/                 # æŒ‰å¹´ä»½åˆ†ç›®å½•
â”‚   â”‚   â”œâ”€â”€ 12/               # æŒ‰æœˆä»½åˆ†ç›®å½•
â”‚   â”‚   â”‚   â”œâ”€â”€ original/     # åŸå›¾
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ 1234567890123456.jpg
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ 1234567890123457.png
â”‚   â”‚   â”‚   â”œâ”€â”€ thumb/        # ç¼©ç•¥å›¾ (150x150)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ 1234567890123456.jpg
â”‚   â”‚   â”‚   â”œâ”€â”€ small/        # å°å›¾ (400x300)
â”‚   â”‚   â”‚   â”œâ”€â”€ medium/       # ä¸­å›¾ (800x600)
â”‚   â”‚   â”‚   â””â”€â”€ large/        # å¤§å›¾ (1200x900)
â”œâ”€â”€ Documents/                 # æ–‡æ¡£æ–‡ä»¶
â”‚   â”œâ”€â”€ 2025/12/
â”‚   â”‚   â”œâ”€â”€ xxx.pdf
â”‚   â”‚   â””â”€â”€ yyy.docx
â”œâ”€â”€ Avatars/                   # ç”¨æˆ·å¤´åƒ
â”‚   â”œâ”€â”€ 2025/12/
â”‚   â”‚   â”œâ”€â”€ user_1.jpg
â”‚   â”‚   â””â”€â”€ user_2.png
â””â”€â”€ Temp/                      # ä¸´æ—¶æ–‡ä»¶ï¼ˆå®šæœŸæ¸…ç†ï¼‰
    â”œâ”€â”€ upload_xxx.tmp
```

#### é™æ€æ–‡ä»¶è®¿é—®é…ç½®
```csharp
// Program.cs
app.UseStaticFiles(new StaticFileOptions
{
    FileProvider = new PhysicalFileProvider(
        Path.Combine(Directory.GetCurrentDirectory(), "DataBases", "Uploads")),
    RequestPath = "/uploads",
    OnPrepareResponse = ctx =>
    {
        // è®¾ç½®ç¼“å­˜
        ctx.Context.Response.Headers.Append("Cache-Control", "public,max-age=31536000");
    }
});
```

**è®¿é—® URL**ï¼š`https://api.example.com/uploads/Images/2025/12/original/xxx.jpg`

---

### æ–¹æ¡ˆ 2ï¼šäº‘å¯¹è±¡å­˜å‚¨ï¼ˆOSS/S3ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒã€æœ‰ä¸€å®šè§„æ¨¡çš„é¡¹ç›®

#### ä¸»æµæœåŠ¡å•†å¯¹æ¯”

| æœåŠ¡å•† | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ | ä»·æ ¼ï¼ˆå‚è€ƒï¼‰ |
|--------|------|----------|--------------|
| **é˜¿é‡Œäº‘ OSS** | å›½å†…è®¿é—®å¿«ï¼Œç”Ÿæ€å®Œå–„ | å›½å†…ä¸šåŠ¡ä¸ºä¸» | å­˜å‚¨ï¼š0.12å…ƒ/GB/æœˆ<br>æµé‡ï¼š0.5å…ƒ/GB |
| **è…¾è®¯äº‘ COS** | ä¸å¾®ä¿¡ç”Ÿæ€é›†æˆå¥½ | å¾®ä¿¡å°ç¨‹åºç­‰ | å­˜å‚¨ï¼š0.11å…ƒ/GB/æœˆ<br>æµé‡ï¼š0.5å…ƒ/GB |
| **AWS S3** | å›½é™…æ ‡å‡†ï¼Œç”Ÿæ€æœ€å®Œå–„ | å›½é™…ä¸šåŠ¡ | å­˜å‚¨ï¼š$0.023/GB/æœˆ<br>æµé‡ï¼š$0.09/GB |
| **ä¸ƒç‰›äº‘ KODO** | å…è´¹é¢åº¦å¤§ï¼Œé€‚åˆå°é¡¹ç›® | åˆåˆ›é¡¹ç›® | 10GBå­˜å‚¨å…è´¹<br>10GBæµé‡å…è´¹/æœˆ |
| **MinIO** | å¼€æºè‡ªå»ºï¼ŒS3å…¼å®¹ | ç§æœ‰äº‘éƒ¨ç½² | å…è´¹ï¼ˆè‡ªå»ºæˆæœ¬ï¼‰ |

#### ä¼˜ç‚¹
- âœ… **é«˜å¯ç”¨**ï¼š99.9999999% æ•°æ®å¯é æ€§ï¼Œå¤šå‰¯æœ¬è‡ªåŠ¨å¤‡ä»½
- âœ… **æ— é™æ‰©å±•**ï¼šä¸ç”¨æ‹…å¿ƒå­˜å‚¨å®¹é‡ï¼ŒæŒ‰éœ€æ‰©å±•
- âœ… **è‡ªå¸¦ CDN**ï¼šå…¨çƒèŠ‚ç‚¹åˆ†å‘ï¼Œè®¿é—®é€Ÿåº¦å¿«
- âœ… **æŒ‰é‡ä»˜è´¹**ï¼šç”¨å¤šå°‘ä»˜å¤šå°‘ï¼Œæˆæœ¬å¯æ§
- âœ… **å›¾ç‰‡å¤„ç†**ï¼šå†…ç½®ç¼©ç•¥å›¾ã€æ°´å°ã€è£å‰ªã€æ ¼å¼è½¬æ¢ç­‰åŠŸèƒ½
- âœ… **æƒé™æ§åˆ¶**ï¼šç²¾ç»†çš„è®¿é—®æ§åˆ¶ï¼ˆå…¬å¼€/ç§æœ‰/ä¸´æ—¶æˆæƒï¼‰
- âœ… **æ—¥å¿—å®¡è®¡**ï¼šå®Œå–„çš„è®¿é—®æ—¥å¿—å’Œç»Ÿè®¡åˆ†æ
- âœ… **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ–‡ä»¶ï¼ŒèŠ‚çœæˆæœ¬

#### ç¼ºç‚¹
- âŒ **éœ€è¦ä»˜è´¹**ï¼šè™½ç„¶ä¸è´µï¼Œä½†éœ€è¦æˆæœ¬é¢„ç®—
- âŒ **å­¦ä¹ æˆæœ¬**ï¼šéœ€è¦äº†è§£ SDK å’Œ API ä½¿ç”¨
- âŒ **ç¬¬ä¸‰æ–¹ä¾èµ–**ï¼šä¾èµ–äº‘æœåŠ¡å•†ç¨³å®šæ€§
- âŒ **ç½‘ç»œè¦æ±‚**ï¼šéœ€è¦æœåŠ¡å™¨èƒ½è®¿é—®å…¬ç½‘

#### é˜¿é‡Œäº‘ OSS ç¤ºä¾‹é…ç½®
```json
{
  "OSS": {
    "Endpoint": "oss-cn-hangzhou.aliyuncs.com",
    "BucketName": "radish-uploads",
    "AccessKeyId": "YOUR_ACCESS_KEY_ID",
    "AccessKeySecret": "YOUR_ACCESS_KEY_SECRET",
    "Domain": "https://cdn.example.com",  // è‡ªå®šä¹‰åŸŸå
    "IsPrivate": false,  // æ˜¯å¦ç§æœ‰ Bucket
    "EnableCdn": true,   // æ˜¯å¦å¯ç”¨ CDN
    "ImageProcess": {
      "Thumb": "image/resize,m_fill,w_150,h_150",      // ç¼©ç•¥å›¾
      "Small": "image/resize,m_lfit,w_400,h_300",      // å°å›¾
      "Medium": "image/resize,m_lfit,w_800,h_600",     // ä¸­å›¾
      "Watermark": "image/watermark,text_UmFkaXNo"     // æ°´å°
    }
  }
}
```

**è®¿é—® URL**ï¼š`https://cdn.example.com/images/xxx.jpg?x-oss-process=image/resize,w_400`

---

### æ–¹æ¡ˆ 3ï¼šMinIOï¼ˆå¼€æº S3 å…¼å®¹å­˜å‚¨ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç§æœ‰äº‘éƒ¨ç½²ã€å¯¹æ•°æ®å®‰å…¨æœ‰ä¸¥æ ¼è¦æ±‚çš„åœºæ™¯

#### ä¼˜ç‚¹
- âœ… **å¼€æºå…è´¹**ï¼šæ— éœ€ä»˜è´¹ï¼Œä»£ç å¼€æºå¯å®¡è®¡
- âœ… **S3 å…¼å®¹**ï¼šå…¼å®¹ AWS S3 APIï¼Œæ˜“äºè¿ç§»
- âœ… **ç§æœ‰éƒ¨ç½²**ï¼šæ•°æ®å®Œå…¨æŒæ§ï¼Œä¸ä¾èµ–ç¬¬ä¸‰æ–¹
- âœ… **æ€§èƒ½ä¼˜å¼‚**ï¼šé«˜æ€§èƒ½å¯¹è±¡å­˜å‚¨ï¼Œæ”¯æŒ SSD
- âœ… **æ˜“äºéƒ¨ç½²**ï¼šDocker ä¸€é”®éƒ¨ç½²ï¼Œå¼€ç®±å³ç”¨
- âœ… **åˆ†å¸ƒå¼**ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œé«˜å¯ç”¨

#### ç¼ºç‚¹
- âŒ **è¿ç»´æˆæœ¬**ï¼šéœ€è¦è‡ªå·±ç»´æŠ¤æœåŠ¡å™¨
- âŒ **æ—  CDN**ï¼šéœ€è¦è‡ªå·±é…ç½® CDN æˆ–åå‘ä»£ç†
- âŒ **å¤‡ä»½æˆæœ¬**ï¼šéœ€è¦è‡ªå·±å®ç°å¤‡ä»½ç­–ç•¥

#### Docker éƒ¨ç½²ç¤ºä¾‹
```bash
# å•èŠ‚ç‚¹æ¨¡å¼ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio \
  -v /data/minio:/data \
  -e "MINIO_ROOT_USER=admin" \
  -e "MINIO_ROOT_PASSWORD=your_password" \
  minio/minio server /data --console-address ":9001"
```

**è®¿é—® URL**ï¼š`http://localhost:9000/radish-uploads/images/xxx.jpg`

---

### æ–¹æ¡ˆ 4ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰â­

**æ ¸å¿ƒæ€æƒ³**ï¼šå®šä¹‰ç»Ÿä¸€çš„å­˜å‚¨æ¥å£ï¼Œé€šè¿‡é…ç½®åˆ‡æ¢ä¸åŒçš„å­˜å‚¨å®ç°

#### æ¶æ„è®¾è®¡
```csharp
// ç»Ÿä¸€æ¥å£
public interface IFileStorage
{
    Task<FileUploadResult> UploadAsync(Stream stream, string fileName, string contentType);
    Task<bool> DeleteAsync(string filePath);
    Task<Stream> DownloadAsync(string filePath);
    string GetFileUrl(string filePath);
    Task<bool> ExistsAsync(string filePath);
}

// æœ¬åœ°å­˜å‚¨å®ç°
public class LocalFileStorage : IFileStorage
{
    // å®ç°ç»†èŠ‚...
}

// OSS å­˜å‚¨å®ç°
public class OssFileStorage : IFileStorage
{
    // å®ç°ç»†èŠ‚...
}

// MinIO å­˜å‚¨å®ç°
public class MinioFileStorage : IFileStorage
{
    // å®ç°ç»†èŠ‚...
}

// å·¥å‚ç±»
public class FileStorageFactory
{
    public static IFileStorage Create(FileStorageOptions options)
    {
        return options.Type switch
        {
            StorageType.Local => new LocalFileStorage(options.Local),
            StorageType.OSS => new OssFileStorage(options.OSS),
            StorageType.MinIO => new MinioFileStorage(options.MinIO),
            _ => throw new NotSupportedException()
        };
    }
}
```

#### é…ç½®æ–‡ä»¶
```json
{
  "FileStorage": {
    "Type": "Local",  // Local / OSS / MinIO
    "MaxFileSize": 5242880,  // 5MB
    "AllowedExtensions": [".jpg", ".jpeg", ".png", ".gif", ".webp", ".pdf", ".doc", ".docx"],
    "Local": {
      "BasePath": "DataBases/Uploads",
      "BaseUrl": "/uploads"
    },
    "OSS": {
      "Endpoint": "oss-cn-hangzhou.aliyuncs.com",
      "BucketName": "radish-uploads",
      "AccessKeyId": "",
      "AccessKeySecret": "",
      "Domain": "https://cdn.example.com"
    },
    "MinIO": {
      "Endpoint": "localhost:9000",
      "BucketName": "radish-uploads",
      "AccessKey": "admin",
      "SecretKey": "",
      "UseSSL": false
    }
  }
}
```

#### ä¼˜ç‚¹
- âœ… **çµæ´»åˆ‡æ¢**ï¼šå¼€å‘ç”¨æœ¬åœ°ï¼Œæµ‹è¯•ç”¨ MinIOï¼Œç”Ÿäº§ç”¨ OSS
- âœ… **æ˜“äºè¿ç§»**ï¼šæ›´æ¢å­˜å‚¨æ–¹æ¡ˆåªéœ€æ”¹é…ç½®
- âœ… **é™ä½æˆæœ¬**ï¼šå¼€å‘é˜¶æ®µä¸éœ€è¦äº‘å­˜å‚¨è´¹ç”¨
- âœ… **ç»Ÿä¸€æ¥å£**ï¼šä¸šåŠ¡ä»£ç æ— éœ€ä¿®æ”¹

#### ä½¿ç”¨ç¤ºä¾‹
```csharp
// Controller
public class UploadController : ControllerBase
{
    private readonly IFileStorage _fileStorage;

    public UploadController(IFileStorage fileStorage)
    {
        _fileStorage = fileStorage;
    }

    [HttpPost]
    public async Task<IActionResult> Upload(IFormFile file)
    {
        using var stream = file.OpenReadStream();
        var result = await _fileStorage.UploadAsync(stream, file.FileName, file.ContentType);
        return Ok(new { url = result.Url });
    }
}
```

---

## ğŸš€ ä¸Šä¼ æ–¹å¼å¯¹æ¯”

### æ–¹å¼ 1ï¼šç›´æ¥ä¸Šä¼ åˆ°åº”ç”¨æœåŠ¡å™¨

#### æµç¨‹å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP POST    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ä¿å­˜æ–‡ä»¶    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ API æœåŠ¡å™¨   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  å­˜å‚¨   â”‚
â”‚ (æµè§ˆå™¨) â”‚                 â”‚ (ASP.NET)    â”‚              â”‚(Local/OSS)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¼˜ç‚¹
- âœ… **å®ç°ç®€å•**ï¼šä½¿ç”¨ `IFormFile` å³å¯ï¼Œä»£ç é‡å°‘
- âœ… **æ˜“äºæ§åˆ¶**ï¼šå®Œå…¨æŒæ§ä¸Šä¼ æµç¨‹ï¼Œä¾¿äºæ·»åŠ ä¸šåŠ¡é€»è¾‘
- âœ… **å®‰å…¨æ€§å¥½**ï¼šç»Ÿä¸€é‰´æƒå’Œæ ¡éªŒï¼Œä¸æ˜“è¢«ç»•è¿‡
- âœ… **ä¾¿äºå®¡è®¡**ï¼šæ‰€æœ‰ä¸Šä¼ éƒ½ç»è¿‡æœåŠ¡å™¨ï¼Œæ˜“äºè®°å½•æ—¥å¿—

#### ç¼ºç‚¹
- âŒ **å ç”¨å¸¦å®½**ï¼šæ–‡ä»¶æµç»æœåŠ¡å™¨ï¼Œå ç”¨ä¸Šè¡Œå¸¦å®½
- âŒ **æ€§èƒ½ç“¶é¢ˆ**ï¼šå¤§é‡å¹¶å‘ä¸Šä¼ ä¼šç»™æœåŠ¡å™¨å¸¦æ¥å‹åŠ›
- âŒ **å¤§æ–‡ä»¶æ…¢**ï¼šå¤§æ–‡ä»¶ä¸Šä¼ éœ€è¦å ç”¨æœåŠ¡å™¨è¿æ¥æ—¶é—´
- âŒ **æ‰©å±•æ€§å·®**ï¼šæœåŠ¡å™¨æ•°é‡å¢åŠ æ—¶ï¼Œéœ€è¦å…±äº«å­˜å‚¨

#### é€‚ç”¨åœºæ™¯
- å°æ–‡ä»¶ï¼ˆ< 5MBï¼‰
- å¹¶å‘é‡ä¸å¤§ï¼ˆ< 100 å¹¶å‘ï¼‰
- éœ€è¦ä¸¥æ ¼æ ¡éªŒå’Œå®¡æ ¸
- å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ

#### å®ç°ç¤ºä¾‹
```csharp
[HttpPost]
[RequestSizeLimit(5_242_880)] // 5MB
public async Task<IActionResult> Upload(IFormFile file)
{
    if (file == null || file.Length == 0)
        return BadRequest("æ–‡ä»¶ä¸èƒ½ä¸ºç©º");

    // 1. æ ¡éªŒæ–‡ä»¶ç±»å‹
    if (!IsAllowedExtension(file.FileName))
        return BadRequest("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹");

    // 2. æ ¡éªŒæ–‡ä»¶å¤§å°
    if (file.Length > 5_242_880)
        return BadRequest("æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶");

    // 3. ä¸Šä¼ æ–‡ä»¶
    using var stream = file.OpenReadStream();
    var result = await _fileStorage.UploadAsync(stream, file.FileName, file.ContentType);

    // 4. ä¿å­˜è®°å½•åˆ°æ•°æ®åº“
    var attachment = new Attachment
    {
        OriginalName = file.FileName,
        StoredName = result.StoredName,
        FileSize = file.Length,
        Url = result.Url,
        UploaderId = _currentUser.UserId
    };
    await _attachmentService.AddAsync(attachment);

    return Ok(new { url = result.Url, id = attachment.Id });
}
```

---

### æ–¹å¼ 2ï¼šå‰ç«¯ç›´ä¼  OSSï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰â­

#### æµç¨‹å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  1.è¯·æ±‚ç­¾å   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ API æœåŠ¡å™¨   â”‚
â”‚ (æµè§ˆå™¨) â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ (ASP.NET)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  2.è¿”å›ç­¾å  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 3.ç›´æ¥ä¸Šä¼ 
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  4.ä¸Šä¼ æˆåŠŸ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OSS   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ API æœåŠ¡å™¨   â”‚
â”‚ (é˜¿é‡Œäº‘) â”‚             â”‚ (å›è°ƒ/é€šçŸ¥)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¼˜ç‚¹
- âœ… **ä¸å ç”¨æœåŠ¡å™¨å¸¦å®½**ï¼šæ–‡ä»¶ç›´æ¥ä¸Šä¼ åˆ° OSSï¼Œä¸ç»è¿‡æœåŠ¡å™¨
- âœ… **ä¸Šä¼ é€Ÿåº¦å¿«**ï¼šOSS æœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œå°±è¿‘ä¸Šä¼ 
- âœ… **æ”¯æŒå¤§æ–‡ä»¶**ï¼šå¯ä¸Šä¼  GB çº§æ–‡ä»¶ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
- âœ… **å‡è½»æœåŠ¡å™¨å‹åŠ›**ï¼šæœåŠ¡å™¨åªéœ€è¦ç”Ÿæˆç­¾å

#### ç¼ºç‚¹
- âŒ **å®ç°ç¨å¤æ‚**ï¼šéœ€è¦å‰ç«¯é›†æˆ SDKï¼Œå¤„ç†ç­¾åé€»è¾‘
- âŒ **è·¨åŸŸé…ç½®**ï¼šéœ€è¦åœ¨ OSS é…ç½® CORS è§„åˆ™
- âŒ **å®‰å…¨æ€§è¦æ±‚é«˜**ï¼šç­¾åæœºåˆ¶è¦è®¾è®¡å¥½ï¼Œé˜²æ­¢æ»¥ç”¨

#### é€‚ç”¨åœºæ™¯
- ç”Ÿäº§ç¯å¢ƒ
- å¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆ> 10MBï¼‰
- é«˜å¹¶å‘åœºæ™¯
- éœ€è¦ CDN åŠ é€Ÿ

#### åç«¯å®ç°ï¼ˆç”Ÿæˆç­¾åï¼‰
```csharp
[HttpPost("upload/signature")]
public IActionResult GetUploadSignature([FromBody] SignatureRequest request)
{
    // 1. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
    var fileName = $"{DateTime.Now:yyyyMMdd}/{Guid.NewGuid()}{Path.GetExtension(request.FileName)}";

    // 2. ç”Ÿæˆä¸Šä¼ ç­–ç•¥
    var policy = new
    {
        expiration = DateTime.UtcNow.AddMinutes(10).ToString("yyyy-MM-ddTHH:mm:ssZ"),
        conditions = new[]
        {
            new { bucket = "radish-uploads" },
            new[] { "content-length-range", 0, 5242880 }, // æœ€å¤§ 5MB
            new[] { "starts-with", "$key", "images/" }
        }
    };

    // 3. è®¡ç®—ç­¾å
    var signature = CalculateSignature(policy);

    return Ok(new
    {
        accessKeyId = _ossConfig.AccessKeyId,
        policy = Convert.ToBase64String(Encoding.UTF8.GetBytes(JsonSerializer.Serialize(policy))),
        signature = signature,
        bucket = "radish-uploads",
        key = fileName,
        host = $"https://{_ossConfig.BucketName}.{_ossConfig.Endpoint}"
    });
}
```

#### å‰ç«¯å®ç°ï¼ˆç›´ä¼  OSSï¼‰
```typescript
// 1. è·å–ç­¾å
const getSignature = async (fileName: string) => {
  const response = await apiPost('/api/v1/Upload/signature', { fileName });
  return response.data;
};

// 2. ä¸Šä¼ æ–‡ä»¶
const uploadToOss = async (file: File) => {
  const signature = await getSignature(file.name);

  const formData = new FormData();
  formData.append('OSSAccessKeyId', signature.accessKeyId);
  formData.append('policy', signature.policy);
  formData.append('signature', signature.signature);
  formData.append('key', signature.key);
  formData.append('file', file);

  await axios.post(signature.host, formData, {
    onUploadProgress: (e) => {
      const percent = Math.round((e.loaded * 100) / e.total);
      console.log(`ä¸Šä¼ è¿›åº¦: ${percent}%`);
    }
  });

  // 3. é€šçŸ¥åç«¯
  const fileUrl = `${signature.host}/${signature.key}`;
  await apiPost('/api/v1/Upload/callback', {
    url: fileUrl,
    fileName: file.name,
    fileSize: file.size
  });

  return fileUrl;
};
```

---

### æ–¹å¼ 3ï¼šåˆ†ç‰‡ä¸Šä¼ ï¼ˆå¤§æ–‡ä»¶ä¸“ç”¨ï¼‰

#### é€‚ç”¨åœºæ™¯
- è¶…å¤§æ–‡ä»¶ï¼ˆ> 100MBï¼‰
- éœ€è¦æ–­ç‚¹ç»­ä¼ 
- ç½‘ç»œä¸ç¨³å®šç¯å¢ƒ

#### ä¼˜ç‚¹
- âœ… **æ”¯æŒè¶…å¤§æ–‡ä»¶**ï¼šå¯ä¸Šä¼  GB ç”šè‡³ TB çº§æ–‡ä»¶
- âœ… **æ–­ç‚¹ç»­ä¼ **ï¼šç½‘ç»œä¸­æ–­åå¯ç»§ç»­ä¸Šä¼ ï¼Œä¸éœ€è¦é‡å¤´å¼€å§‹
- âœ… **å¹¶è¡Œä¸Šä¼ **ï¼šå¤šä¸ªåˆ†ç‰‡å¯å¹¶è¡Œä¸Šä¼ ï¼Œæå‡é€Ÿåº¦
- âœ… **èŠ‚çœå¸¦å®½**ï¼šå¤±è´¥åªéœ€é‡ä¼ å‡ºé”™çš„åˆ†ç‰‡

#### å®ç°æµç¨‹
```
1. å‰ç«¯ï¼šå°†æ–‡ä»¶åˆ‡ç‰‡ï¼ˆå¦‚æ¯ç‰‡ 2MBï¼‰
2. å‰ç«¯ï¼šé€ç‰‡ä¸Šä¼ ï¼Œè®°å½•è¿›åº¦
3. åç«¯ï¼šæ¥æ”¶åˆ†ç‰‡ï¼Œä¸´æ—¶å­˜å‚¨
4. å‰ç«¯ï¼šæ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåï¼Œé€šçŸ¥åç«¯åˆå¹¶
5. åç«¯ï¼šåˆå¹¶åˆ†ç‰‡ï¼Œç”Ÿæˆæœ€ç»ˆæ–‡ä»¶
6. åç«¯ï¼šåˆ é™¤ä¸´æ—¶åˆ†ç‰‡
```

#### æŠ€æœ¯è¦ç‚¹
```typescript
// å‰ç«¯ï¼šæ–‡ä»¶åˆ‡ç‰‡
const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB

const uploadFile = async (file: File) => {
  const chunks = Math.ceil(file.size / CHUNK_SIZE);
  const fileHash = await calculateHash(file); // MD5

  for (let i = 0; i < chunks; i++) {
    const start = i * CHUNK_SIZE;
    const end = Math.min(start + CHUNK_SIZE, file.size);
    const chunk = file.slice(start, end);

    await uploadChunk({
      file: chunk,
      chunkIndex: i,
      totalChunks: chunks,
      fileHash: fileHash
    });
  }

  // é€šçŸ¥åˆå¹¶
  await mergeChunks({ fileHash, fileName: file.name });
};
```

```csharp
// åç«¯ï¼šæ¥æ”¶åˆ†ç‰‡
[HttpPost("upload/chunk")]
public async Task<IActionResult> UploadChunk([FromForm] ChunkUploadRequest request)
{
    var chunkPath = Path.Combine(_tempPath, request.FileHash, $"{request.ChunkIndex}.tmp");

    Directory.CreateDirectory(Path.GetDirectoryName(chunkPath));

    using var stream = new FileStream(chunkPath, FileMode.Create);
    await request.File.CopyToAsync(stream);

    return Ok();
}

// åç«¯ï¼šåˆå¹¶åˆ†ç‰‡
[HttpPost("upload/merge")]
public async Task<IActionResult> MergeChunks([FromBody] MergeRequest request)
{
    var chunkDir = Path.Combine(_tempPath, request.FileHash);
    var chunks = Directory.GetFiles(chunkDir).OrderBy(f => int.Parse(Path.GetFileNameWithoutExtension(f)));

    var finalPath = Path.Combine(_uploadPath, $"{Guid.NewGuid()}{Path.GetExtension(request.FileName)}");

    using var finalStream = new FileStream(finalPath, FileMode.Create);
    foreach (var chunkPath in chunks)
    {
        using var chunkStream = new FileStream(chunkPath, FileMode.Open);
        await chunkStream.CopyToAsync(finalStream);
    }

    // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
    Directory.Delete(chunkDir, true);

    return Ok(new { url = GetFileUrl(finalPath) });
}
```

---

## ğŸ”’ å®‰å…¨æ€§è®¾è®¡

### 1. æ–‡ä»¶ç±»å‹æ ¡éªŒ

#### ç™½åå•æœºåˆ¶ï¼ˆæ¨èï¼‰
```csharp
private static readonly Dictionary<string, string[]> AllowedTypes = new()
{
    ["image"] = new[] { ".jpg", ".jpeg", ".png", ".gif", ".webp", ".bmp" },
    ["document"] = new[] { ".pdf", ".doc", ".docx", ".xls", ".xlsx", ".ppt", ".pptx", ".txt" },
    ["video"] = new[] { ".mp4", ".avi", ".mov", ".wmv", ".flv", ".mkv" },
    ["audio"] = new[] { ".mp3", ".wav", ".ogg", ".m4a", ".flac" }
};

// ç¦æ­¢çš„æ‰©å±•åï¼ˆé»‘åå•ï¼‰
private static readonly string[] ForbiddenExtensions = new[]
{
    ".exe", ".bat", ".cmd", ".sh", ".dll", ".so", ".dylib",
    ".js", ".vbs", ".ps1", ".php", ".asp", ".jsp", ".html"
};
```

#### Magic Number æ£€æŸ¥ï¼ˆæ–‡ä»¶å¤´æ ¡éªŒï¼‰
```csharp
private static readonly Dictionary<string, byte[]> FileSignatures = new()
{
    [".jpg"] = new byte[] { 0xFF, 0xD8, 0xFF },
    [".png"] = new byte[] { 0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A },
    [".gif"] = new byte[] { 0x47, 0x49, 0x46, 0x38 },
    [".pdf"] = new byte[] { 0x25, 0x50, 0x44, 0x46 },
    [".zip"] = new byte[] { 0x50, 0x4B, 0x03, 0x04 },
};

private bool ValidateFileSignature(Stream stream, string extension)
{
    if (!FileSignatures.TryGetValue(extension.ToLower(), out var expectedSignature))
        return false;

    var buffer = new byte[expectedSignature.Length];
    stream.Read(buffer, 0, buffer.Length);
    stream.Position = 0; // é‡ç½®æµä½ç½®

    return buffer.SequenceEqual(expectedSignature);
}
```

### 2. æ–‡ä»¶å¤§å°é™åˆ¶

```csharp
public class FileSizeLimits
{
    public const long Avatar = 2 * 1024 * 1024;        // 2MB
    public const long Image = 5 * 1024 * 1024;         // 5MB
    public const long Document = 10 * 1024 * 1024;     // 10MB
    public const long Video = 100 * 1024 * 1024;       // 100MB
}

// é…ç½®è¯·æ±‚å¤§å°é™åˆ¶
[RequestSizeLimit(FileSizeLimits.Image)]
[RequestFormLimits(MultipartBodyLengthLimit = FileSizeLimits.Image)]
public async Task<IActionResult> Upload(IFormFile file) { }
```

### 3. æ–‡ä»¶åå¤„ç†

```csharp
public class FileNameGenerator
{
    // ä½¿ç”¨é›ªèŠ±IDç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
    public static string GenerateUniqueFileName(string originalName)
    {
        var extension = Path.GetExtension(originalName);
        var uniqueName = $"{SnowFlakeSingle.Instance.NextId()}{extension}";
        return uniqueName;
    }

    // ç”Ÿæˆå¸¦æ—¥æœŸçš„è·¯å¾„
    public static string GenerateFilePath(string category, string fileName)
    {
        var now = DateTime.Now;
        return Path.Combine(category, now.Year.ToString(), now.Month.ToString("D2"), fileName);
    }

    // æ¸…ç†æ–‡ä»¶åï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
    public static string SanitizeFileName(string fileName)
    {
        var invalidChars = Path.GetInvalidFileNameChars();
        var sanitized = string.Join("_", fileName.Split(invalidChars));
        return sanitized;
    }
}
```

### 4. è®¿é—®æƒé™æ§åˆ¶

#### å…¬å¼€æ–‡ä»¶
```csharp
// ä»»ä½•äººå¯è®¿é—®
public string GetPublicUrl(string filePath)
{
    return $"{_baseUrl}/{filePath}";
}
```

#### ç§æœ‰æ–‡ä»¶ï¼ˆéœ€è¦é‰´æƒï¼‰
```csharp
[Authorize]
[HttpGet("download/{id}")]
public async Task<IActionResult> Download(long id)
{
    var attachment = await _attachmentService.QueryByIdAsync(id);
    if (attachment == null)
        return NotFound();

    // æƒé™æ£€æŸ¥
    if (!attachment.IsPublic && attachment.UploaderId != _currentUser.UserId)
        return Forbid();

    var stream = await _fileStorage.DownloadAsync(attachment.StoragePath);
    return File(stream, attachment.MimeType, attachment.OriginalName);
}
```

#### ä¸´æ—¶æˆæƒ URLï¼ˆå¸¦ç­¾åï¼‰
```csharp
public string GetTemporaryUrl(string filePath, int expirationMinutes = 60)
{
    var expiration = DateTimeOffset.UtcNow.AddMinutes(expirationMinutes).ToUnixTimeSeconds();
    var signature = GenerateSignature(filePath, expiration);

    return $"{_baseUrl}/{filePath}?expires={expiration}&signature={signature}";
}

private string GenerateSignature(string filePath, long expiration)
{
    var data = $"{filePath}|{expiration}";
    using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(_secretKey));
    var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(data));
    return Convert.ToBase64String(hash);
}
```

### 5. æ¶æ„æ–‡ä»¶é˜²æŠ¤

#### å›¾ç‰‡å®‰å…¨å¤„ç†
```csharp
// å»é™¤ EXIF ä¿¡æ¯ï¼ˆå¯èƒ½å«æœ‰æ¶æ„ä»£ç æˆ–éšç§ä¿¡æ¯ï¼‰
public async Task<Stream> SanitizeImage(Stream inputStream)
{
    using var image = await Image.LoadAsync(inputStream);

    // ç§»é™¤ EXIF æ•°æ®
    image.Metadata.ExifProfile = null;

    // é‡æ–°ç¼–ç 
    var outputStream = new MemoryStream();
    await image.SaveAsJpegAsync(outputStream);
    outputStream.Position = 0;

    return outputStream;
}
```

#### ç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼‰
```csharp
// é›†æˆ ClamAV ç—…æ¯’æ‰«æ
public async Task<bool> ScanForVirus(Stream stream)
{
    // ä½¿ç”¨ ClamAV æˆ–å…¶ä»–åç—…æ¯’å¼•æ“æ‰«æ
    var clam = new ClamClient("localhost", 3310);
    var result = await clam.SendAndScanFileAsync(stream);

    return result.Result == ClamScanResults.Clean;
}
```

#### å†…å®¹å®¡æ ¸ï¼ˆäº‘æœåŠ¡ï¼‰
```csharp
// è°ƒç”¨é˜¿é‡Œäº‘å†…å®¹å®‰å…¨ API
public async Task<ContentAuditResult> AuditContent(string imageUrl)
{
    var client = new ContentAuditClient(_config);
    var result = await client.ScanImageAsync(imageUrl);

    return new ContentAuditResult
    {
        IsSafe = result.Suggestion == "pass",
        Labels = result.Labels, // è¿è§„æ ‡ç­¾ï¼šporn, terrorism, adç­‰
        Score = result.Score
    };
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. å›¾ç‰‡å¤„ç†ç­–ç•¥

#### ä¸Šä¼ æ—¶è‡ªåŠ¨å¤„ç†
```csharp
public async Task<ImageUploadResult> UploadImage(Stream stream, string fileName)
{
    var result = new ImageUploadResult();

    // åŠ è½½å›¾ç‰‡
    using var image = await Image.LoadAsync(stream);

    // 1. ç”Ÿæˆå¤šç§å°ºå¯¸
    result.Thumbnail = await GenerateThumbnail(image, 150, 150);   // ç¼©ç•¥å›¾
    result.Small = await ResizeImage(image, 400, 300);             // å°å›¾
    result.Medium = await ResizeImage(image, 800, 600);            // ä¸­å›¾
    result.Large = await ResizeImage(image, 1200, 900);            // å¤§å›¾

    // 2. å‹ç¼©åŸå›¾ï¼ˆè´¨é‡ 85%ï¼‰
    result.Original = await CompressImage(image, 85);

    // 3. å¯é€‰ï¼šæ·»åŠ æ°´å°
    if (_options.EnableWatermark)
    {
        result.Original = await AddWatermark(result.Original);
    }

    return result;
}

private async Task<string> ResizeImage(Image image, int maxWidth, int maxHeight)
{
    var clone = image.Clone(ctx => ctx.Resize(new ResizeOptions
    {
        Mode = ResizeMode.Max,
        Size = new Size(maxWidth, maxHeight)
    }));

    var fileName = $"{Guid.NewGuid()}.jpg";
    var filePath = Path.Combine(_uploadPath, "resized", fileName);

    await clone.SaveAsJpegAsync(filePath, new JpegEncoder { Quality = 85 });

    return filePath;
}
```

#### å›¾ç‰‡æ ¼å¼è½¬æ¢
```csharp
// è‡ªåŠ¨è½¬æ¢ä¸º WebP æ ¼å¼ï¼ˆæ›´å°çš„æ–‡ä»¶ä½“ç§¯ï¼‰
public async Task<string> ConvertToWebP(Stream inputStream)
{
    using var image = await Image.LoadAsync(inputStream);

    var outputPath = Path.Combine(_uploadPath, $"{Guid.NewGuid()}.webp");
    await image.SaveAsWebpAsync(outputPath, new WebpEncoder { Quality = 85 });

    return outputPath;
}
```

### 2. CDN åŠ é€Ÿé…ç½®

#### OSS + CDN é…ç½®
```json
{
  "CDN": {
    "Enable": true,
    "Domain": "https://cdn.example.com",
    "CacheControl": "public, max-age=31536000",  // 1å¹´
    "ImageProcess": {
      "Thumbnail": "?x-oss-process=image/resize,m_fill,w_150,h_150/quality,q_85",
      "Small": "?x-oss-process=image/resize,m_lfit,w_400/quality,q_85",
      "Watermark": "?x-oss-process=image/watermark,text_UmFkaXNo,color_FFFFFF,size_20,g_se"
    }
  }
}
```

#### ä½¿ç”¨ç¤ºä¾‹
```csharp
public string GetCdnUrl(string filePath, ImageSize size = ImageSize.Original)
{
    var baseUrl = _cdnConfig.Enable ? _cdnConfig.Domain : _baseUrl;
    var url = $"{baseUrl}/{filePath}";

    // æ·»åŠ å›¾ç‰‡å¤„ç†å‚æ•°
    if (size != ImageSize.Original && _cdnConfig.ImageProcess.ContainsKey(size.ToString()))
    {
        url += _cdnConfig.ImageProcess[size.ToString()];
    }

    return url;
}
```

### 3. æ‡’åŠ è½½å’Œæ¸è¿›å¼åŠ è½½

#### å‰ç«¯å®ç°
```typescript
// 1. åˆ—è¡¨é¡µï¼šåŠ è½½ç¼©ç•¥å›¾ï¼Œæ‡’åŠ è½½
<img
  src={getThumbnailUrl(image.url)}
  loading="lazy"
  data-original={getOriginalUrl(image.url)}
  onClick={handleImageClick}
/>

// 2. ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
const handleImageClick = (e: React.MouseEvent<HTMLImageElement>) => {
  const img = e.currentTarget;
  const originalUrl = img.dataset.original;

  // æ˜¾ç¤º Modalï¼ŒåŠ è½½åŸå›¾
  setLightboxImage(originalUrl);
};

// 3. æ¸è¿›å¼åŠ è½½ï¼ˆå…ˆæ¨¡ç³Šåæ¸…æ™°ï¼‰
const ProgressiveImage = ({ src, placeholder }: Props) => {
  const [loaded, setLoaded] = useState(false);

  return (
    <div className={styles.imageContainer}>
      <img src={placeholder} className={styles.placeholder} />
      <img
        src={src}
        onLoad={() => setLoaded(true)}
        className={loaded ? styles.loaded : styles.loading}
      />
    </div>
  );
};
```

### 4. ä¸Šä¼ è¿›åº¦å’Œä¼˜åŒ–

#### æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
```typescript
const [uploadProgress, setUploadProgress] = useState(0);

const uploadFile = async (file: File) => {
  const formData = new FormData();
  formData.append('file', file);

  await axios.post('/api/v1/Upload', formData, {
    onUploadProgress: (progressEvent) => {
      const percentCompleted = Math.round(
        (progressEvent.loaded * 100) / progressEvent.total!
      );
      setUploadProgress(percentCompleted);
    }
  });
};

// UI ç»„ä»¶
<div className={styles.uploadProgress}>
  <div className={styles.progressBar} style={{ width: `${uploadProgress}%` }} />
  <span>{uploadProgress}%</span>
</div>
```

#### å‹ç¼©åä¸Šä¼ 
```typescript
// ä½¿ç”¨ browser-image-compression åº“
import imageCompression from 'browser-image-compression';

const compressAndUpload = async (file: File) => {
  // å‹ç¼©é…ç½®
  const options = {
    maxSizeMB: 1,              // æœ€å¤§ 1MB
    maxWidthOrHeight: 1920,    // æœ€å¤§å®½é«˜
    useWebWorker: true         // ä½¿ç”¨ Web Worker
  };

  // å‹ç¼©å›¾ç‰‡
  const compressedFile = await imageCompression(file, options);

  // ä¸Šä¼ å‹ç¼©åçš„æ–‡ä»¶
  await uploadFile(compressedFile);
};
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### Attachment è¡¨ï¼ˆé™„ä»¶è¡¨ï¼‰

```csharp
/// <summary>
/// é™„ä»¶è¡¨
/// </summary>
[SugarTable("Attachment")]
public class Attachment : RootEntityTKey<long>
{
    /// <summary>åŸå§‹æ–‡ä»¶å</summary>
    [SugarColumn(Length = 255)]
    public string OriginalName { get; set; }

    /// <summary>å­˜å‚¨æ–‡ä»¶åï¼ˆGUIDï¼‰</summary>
    [SugarColumn(Length = 100)]
    public string StoredName { get; set; }

    /// <summary>æ–‡ä»¶æ‰©å±•å</summary>
    [SugarColumn(Length = 20)]
    public string Extension { get; set; }

    /// <summary>æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰</summary>
    public long FileSize { get; set; }

    /// <summary>MIME ç±»å‹</summary>
    [SugarColumn(Length = 100)]
    public string MimeType { get; set; }

    /// <summary>æ–‡ä»¶å“ˆå¸Œå€¼ï¼ˆMD5/SHA256ï¼‰</summary>
    [SugarColumn(Length = 64)]
    public string? FileHash { get; set; }

    /// <summary>å­˜å‚¨ç±»å‹ï¼ˆLocal/OSS/MinIOï¼‰</summary>
    [SugarColumn(Length = 20)]
    public string StorageType { get; set; }

    /// <summary>å­˜å‚¨è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰</summary>
    [SugarColumn(Length = 500)]
    public string StoragePath { get; set; }

    /// <summary>ç¼©ç•¥å›¾è·¯å¾„</summary>
    [SugarColumn(Length = 500, IsNullable = true)]
    public string? ThumbnailPath { get; set; }

    /// <summary>è®¿é—® URL</summary>
    [SugarColumn(Length = 1000)]
    public string Url { get; set; }

    /// <summary>ä¸Šä¼ è€… ID</summary>
    public long UploaderId { get; set; }

    /// <summary>ä¸Šä¼ è€…åç§°</summary>
    [SugarColumn(Length = 50)]
    public string UploaderName { get; set; }

    /// <summary>ä¸šåŠ¡ç±»å‹ï¼ˆPost/Comment/Avatar/Documentï¼‰</summary>
    [SugarColumn(Length = 50)]
    public string BusinessType { get; set; }

    /// <summary>ä¸šåŠ¡ IDï¼ˆå¦‚ PostIdã€CommentIdï¼‰</summary>
    public long? BusinessId { get; set; }

    /// <summary>æ˜¯å¦å…¬å¼€</summary>
    public bool IsPublic { get; set; } = true;

    /// <summary>ä¸‹è½½æ¬¡æ•°</summary>
    public int DownloadCount { get; set; } = 0;

    /// <summary>å†…å®¹å®¡æ ¸çŠ¶æ€ï¼ˆPending/Pass/Rejectï¼‰</summary>
    [SugarColumn(Length = 20, IsNullable = true)]
    public string? AuditStatus { get; set; }

    /// <summary>å†…å®¹å®¡æ ¸ç»“æœ</summary>
    [SugarColumn(ColumnDataType = "text", IsNullable = true)]
    public string? AuditResult { get; set; }

    /// <summary>å¤‡æ³¨</summary>
    [SugarColumn(Length = 500, IsNullable = true)]
    public string? Remark { get; set; }
}
```

### ç´¢å¼•è®¾è®¡
```csharp
// åˆ›å»ºç´¢å¼•
[SugarIndex("idx_uploader", nameof(UploaderId), OrderByType.Asc)]
[SugarIndex("idx_business", nameof(BusinessType) + "," + nameof(BusinessId), OrderByType.Asc)]
[SugarIndex("idx_hash", nameof(FileHash), OrderByType.Asc)]
```

### ViewModel
```csharp
public class AttachmentVo
{
    public long Id { get; set; }
    public string OriginalName { get; set; }
    public long FileSize { get; set; }
    public string Extension { get; set; }
    public string Url { get; set; }
    public string ThumbnailUrl { get; set; }
    public string UploaderName { get; set; }
    public string CreateTime { get; set; }
    public int DownloadCount { get; set; }
}
```

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### é˜¶æ®µ 1ï¼šMVPï¼ˆå½“å‰å¼€å‘é˜¶æ®µï¼‰

#### å­˜å‚¨æ–¹æ¡ˆ
- **æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨**
- ç›®å½•ç»“æ„ï¼š`DataBases/Uploads/{Category}/{Year}/{Month}/{UniqueFileName}`
- é™æ€æ–‡ä»¶ä¸­é—´ä»¶è®¿é—®

#### ä¸Šä¼ æ–¹å¼
- **ç›´æ¥ä¸Šä¼ åˆ° API æœåŠ¡å™¨**
- ä½¿ç”¨ `IFormFile` æ¥æ”¶æ–‡ä»¶
- åŸºç¡€çš„æ–‡ä»¶æ ¡éªŒï¼ˆç±»å‹ã€å¤§å°ï¼‰

#### å›¾ç‰‡å¤„ç†
- åŸºç¡€å‹ç¼©ï¼ˆè´¨é‡ 85%ï¼‰
- ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆ150x150ï¼‰

#### å®‰å…¨æªæ–½
- æ–‡ä»¶ç±»å‹ç™½åå•
- æ–‡ä»¶å¤§å°é™åˆ¶
- æ–‡ä»¶åéšæœºåŒ–

#### å®ç°é‡ç‚¹
1. âœ… å®šä¹‰ç»Ÿä¸€çš„ `IFileStorage` æ¥å£
2. âœ… å®ç° `LocalFileStorage` æœ¬åœ°å­˜å‚¨
3. âœ… åˆ›å»º `Attachment` è¡¨å’Œç›¸å…³ Service
4. âœ… æä¾›ä¸Šä¼  APIï¼ˆ`/api/v1/Upload`ï¼‰
5. âœ… é›†æˆåˆ° MarkdownEditorï¼ˆå›¾ç‰‡æŒ‰é’®ï¼‰

**ä¼˜ç‚¹**ï¼š
- å¿«é€Ÿå®ç°ï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½
- æ— é¢å¤–æˆæœ¬
- å¼€å‘è°ƒè¯•æ–¹ä¾¿

---

### é˜¶æ®µ 2ï¼šç”Ÿäº§ä¼˜åŒ–ï¼ˆéƒ¨ç½²ä¸Šçº¿å‰ï¼‰

#### å­˜å‚¨æ–¹æ¡ˆ
- **è¿ç§»åˆ°é˜¿é‡Œäº‘ OSS** æˆ– **è‡ªå»º MinIO**
- ä¿æŒæ¥å£ä¸å˜ï¼Œåªæ”¹é…ç½®

#### ä¸Šä¼ æ–¹å¼
- **å‰ç«¯ç›´ä¼  OSS**ï¼ˆå¤§æ–‡ä»¶ï¼‰
- **æœåŠ¡å™¨ä¸­è½¬**ï¼ˆå°æ–‡ä»¶ï¼‰

#### å›¾ç‰‡å¤„ç†
- OSS è‡ªå¸¦å›¾ç‰‡å¤„ç†ï¼ˆå¤šå°ºå¯¸ã€æ°´å°ï¼‰
- æˆ–è‡ªå»ºå›¾ç‰‡å¤„ç†æœåŠ¡

#### CDN åŠ é€Ÿ
- é…ç½® CDN åŸŸå
- è®¾ç½®ç¼“å­˜ç­–ç•¥

#### å®‰å…¨å¢å¼º
- å†…å®¹å®¡æ ¸ï¼ˆè°ƒç”¨äº‘æœåŠ¡ APIï¼‰
- è®¿é—®é¢‘ç‡é™åˆ¶
- ä¸´æ—¶æˆæƒ URL

---

## ğŸ¤” å¾…è®¨è®ºçš„é—®é¢˜

### 1. å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©
- [ ] **é—®é¢˜**ï¼šæ˜¯ç°åœ¨å°±ç”¨ MinIOï¼Œè¿˜æ˜¯å…ˆç”¨æœ¬åœ°å­˜å‚¨ï¼Ÿ
- **æ–¹æ¡ˆ A**ï¼šæœ¬åœ°å­˜å‚¨ï¼ˆå¿«é€Ÿå¼€å‘ï¼Œåç»­è¿ç§»ï¼‰
- **æ–¹æ¡ˆ B**ï¼šç›´æ¥ç”¨ MinIOï¼ˆDocker éƒ¨ç½²ï¼ŒS3 å…¼å®¹ï¼‰
- **å»ºè®®**ï¼šæ–¹æ¡ˆ Aï¼ˆå…ˆå¿«é€Ÿå®ç°ï¼Œæ¥å£è®¾è®¡å¥½ä¾¿äºè¿ç§»ï¼‰

### 2. å›¾ç‰‡å¤„ç†
- [ ] **é—®é¢˜**ï¼šå›¾ç‰‡å¤„ç†åœ¨ä¸Šä¼ æ—¶è¿˜æ˜¯è®¿é—®æ—¶ï¼Ÿ
- **æ–¹æ¡ˆ A**ï¼šä¸Šä¼ æ—¶å¤„ç†ï¼ˆç”Ÿæˆå¤šå°ºå¯¸ï¼Œå ç”¨å­˜å‚¨ï¼‰
- **æ–¹æ¡ˆ B**ï¼šè®¿é—®æ—¶å¤„ç†ï¼ˆæŒ‰éœ€å¤„ç†ï¼ŒèŠ‚çœå­˜å‚¨ï¼‰
- **å»ºè®®**ï¼šæ–¹æ¡ˆ Aï¼ˆæ€§èƒ½å¥½ï¼Œç”¨æˆ·ä½“éªŒä½³ï¼‰

### 3. æ˜¯å¦éœ€è¦æ°´å°
- [ ] **é—®é¢˜**ï¼šå¸–å­å›¾ç‰‡æ˜¯å¦æ·»åŠ æ°´å°ï¼Ÿ
- **è€ƒè™‘**ï¼šé˜²æ­¢ç›—å›¾ vs ç”¨æˆ·ä½“éªŒ
- **å»ºè®®**ï¼šå¯é€‰é…ç½®ï¼Œé»˜è®¤å…³é—­

### 4. æ–‡ä»¶åˆ é™¤ç­–ç•¥
- [ ] **é—®é¢˜**ï¼šåˆ é™¤å¸–å­/è¯„è®ºæ—¶ï¼Œæ˜¯å¦åˆ é™¤å›¾ç‰‡ï¼Ÿ
- **æ–¹æ¡ˆ A**ï¼šè½¯åˆ é™¤ï¼ˆæ ‡è®°ä¸ºåˆ é™¤ï¼Œå®šæœŸæ¸…ç†ï¼‰
- **æ–¹æ¡ˆ B**ï¼šç¡¬åˆ é™¤ï¼ˆç«‹å³åˆ é™¤æ–‡ä»¶ï¼‰
- **å»ºè®®**ï¼šæ–¹æ¡ˆ Aï¼ˆå¯æ¢å¤ï¼Œé˜²æ­¢è¯¯åˆ ï¼‰

### 5. å›¾ç‰‡å®¡æ ¸
- [ ] **é—®é¢˜**ï¼šæ˜¯å¦éœ€è¦å†…å®¹å®¡æ ¸ï¼Ÿ
- **è€ƒè™‘**ï¼šå®‰å…¨åˆè§„ vs æˆæœ¬
- **å»ºè®®**ï¼šMVP é˜¶æ®µä¸åšï¼Œç”Ÿäº§ç¯å¢ƒå¯é€‰

### 6. æ–‡ä»¶å¤§å°é™åˆ¶
- [ ] **é—®é¢˜**ï¼šå„ç±»å‹æ–‡ä»¶çš„å¤§å°é™åˆ¶ï¼Ÿ
- **å½“å‰å»ºè®®**ï¼š
  - å¤´åƒï¼š2MB
  - å¸–å­å›¾ç‰‡ï¼š5MB
  - æ–‡æ¡£ï¼š10MB
- **éœ€è¦ç¡®è®¤**ï¼šæ˜¯å¦åˆç†ï¼Ÿ

### 7. æ”¯æŒçš„æ–‡ä»¶ç±»å‹
- [ ] **é—®é¢˜**ï¼šé™¤äº†å›¾ç‰‡ï¼Œæ˜¯å¦æ”¯æŒè§†é¢‘ã€æ–‡æ¡£ï¼Ÿ
- **MVP é˜¶æ®µ**ï¼šåªæ”¯æŒå›¾ç‰‡
- **åç»­æ‰©å±•**ï¼šPDFã€Office æ–‡æ¡£ã€è§†é¢‘
- **å»ºè®®**ï¼šå…ˆå›¾ç‰‡ï¼Œåç»­æŒ‰éœ€æ‰©å±•

### 8. ä¸Šä¼ å¹¶å‘é™åˆ¶
- [ ] **é—®é¢˜**ï¼šå•ä¸ªç”¨æˆ·åŒæ—¶ä¸Šä¼ æ–‡ä»¶æ•°é™åˆ¶ï¼Ÿ
- **å»ºè®®**ï¼šå•ç”¨æˆ·æœ€å¤š 5 ä¸ªå¹¶å‘ä¸Šä¼ 

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 1. ç¡®è®¤æ–¹æ¡ˆ
- [ ] è®¨è®ºå¹¶ç¡®è®¤ä¸Šè¿°"å¾…è®¨è®ºçš„é—®é¢˜"
- [ ] æ˜ç¡® MVP é˜¶æ®µçš„åŠŸèƒ½èŒƒå›´

### 2. æŠ€æœ¯å‡†å¤‡
- [ ] å®‰è£…å›¾ç‰‡å¤„ç†åº“ï¼ˆå¦‚ SixLabors.ImageSharpï¼‰
- [ ] å‡†å¤‡æµ‹è¯•å›¾ç‰‡ç´ æ

### 3. å¼€å‘è®¡åˆ’
1. **åç«¯**ï¼š
   - [ ] åˆ›å»º `Attachment` å®ä½“å’Œè¡¨
   - [ ] å®ç° `IFileStorage` æ¥å£
   - [ ] å®ç° `LocalFileStorage` æœ¬åœ°å­˜å‚¨
   - [ ] åˆ›å»º `AttachmentService`
   - [ ] å®ç°ä¸Šä¼  API
   - [ ] æ·»åŠ æ–‡ä»¶æ ¡éªŒå’Œå®‰å…¨æ£€æŸ¥

2. **å‰ç«¯**ï¼š
   - [ ] åˆ›å»ºæ–‡ä»¶ä¸Šä¼ ç»„ä»¶
   - [ ] é›†æˆåˆ° MarkdownEditorï¼ˆå›¾ç‰‡æŒ‰é’®ï¼‰
   - [ ] æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
   - [ ] å›¾ç‰‡é¢„è§ˆåŠŸèƒ½

3. **æµ‹è¯•**ï¼š
   - [ ] å•å…ƒæµ‹è¯•
   - [ ] é›†æˆæµ‹è¯•
   - [ ] å‹åŠ›æµ‹è¯•

4. **æ–‡æ¡£**ï¼š
   - [ ] API æ–‡æ¡£
   - [ ] ä½¿ç”¨è¯´æ˜

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æŠ€æœ¯æ–‡æ¡£
- [ASP.NET Core æ–‡ä»¶ä¸Šä¼ ](https://learn.microsoft.com/en-us/aspnet/core/mvc/models/file-uploads)
- [SixLabors.ImageSharp æ–‡æ¡£](https://docs.sixlabors.com/articles/imagesharp/index.html)
- [é˜¿é‡Œäº‘ OSS æ–‡æ¡£](https://help.aliyun.com/product/31815.html)
- [MinIO æ–‡æ¡£](https://min.io/docs/minio/linux/index.html)

### å¼€æºé¡¹ç›®å‚è€ƒ
- [Ant Design ProComponents - Upload](https://procomponents.ant.design/components/upload)
- [Uppy - æ–‡ä»¶ä¸Šä¼ åº“](https://uppy.io/)
- [FilePond - ä¼˜é›…çš„æ–‡ä»¶ä¸Šä¼ ](https://pqina.nl/filepond/)

---

**æ–‡æ¡£çŠ¶æ€**ï¼šè‰ç¨¿å¾…è®¨è®º
**æœ€åæ›´æ–°**ï¼š2025-12-20
**è´£ä»»äºº**ï¼šå¼€å‘å›¢é˜Ÿ
