# M7 P0 阶段测试指南

## 测试环境

### 启动服务

**重要：必须使用 https profile 启动 Gateway，否则会有 CORS 问题！**

```bash
# 1. 启动 Gateway（使用 https profile）
cd /mnt/d/Code/Radish
dotnet run --project Radish.Gateway --launch-profile https

# 2. 启动 Auth
dotnet run --project Radish.Auth

# 3. 启动前端
npm run dev --workspace=radish.client
```

### 服务地址
- **Gateway**: https://localhost:5000（主要）+ http://localhost:5001（备用）
- **Auth**: http://localhost:5200
- **前端**: http://localhost:3000

## 测试场景

### 1. SignalR 连接测试

#### 步骤：
1. 打开浏览器访问 http://localhost:3000
2. 打开浏览器控制台（F12）
3. 登录系统
4. 观察控制台日志

#### 预期结果：
```
[NotificationHub] 启动连接...
[NotificationHub] SignalR 连接成功 - ConnectionId: xxx
[NotificationHub] 未读数更新: 0
```

#### 验证点：
- ✅ SignalR 连接成功建立
- ✅ 连接后自动接收初始未读数（0）
- ✅ Dock 上的状态点显示为在线（绿色）

---

### 2. 实时推送测试

#### 步骤：
1. 确保已登录
2. 打开浏览器控制台
3. 使用测试 API 触发推送：

```bash
# 方法 1: 使用 curl（需要替换 TOKEN）
curl -X POST "https://localhost:5000/api/v1/User/TestPushUnreadCount?count=5" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -k

# 方法 2: 使用浏览器控制台（推荐）
fetch('https://localhost:5000/api/v1/User/TestPushUnreadCount?count=5', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
  }
}).then(r => r.json()).then(console.log)
```

#### 预期结果：
1. 控制台输出：
```
[NotificationHub] 未读数更新: 5
```

2. Dock 组件立即更新：
   - 头像上显示红色徽章，数字为 5
   - **无需等待轮询**，实时更新

#### 验证点：
- ✅ 推送即时到达（< 1秒）
- ✅ UI 立即更新，显示正确的未读数
- ✅ 无控制台错误

---

### 3. 降级轮询测试

#### 步骤：
1. 停止 Gateway 服务（SignalR Hub 托管在 Gateway）
```bash
# 在运行 Gateway 的终端按 Ctrl+C
```

2. 刷新浏览器页面（F5）
3. 登录系统
4. 观察控制台

#### 预期结果：
```
[NotificationHub] 启动连接...
[NotificationHub] SignalR 连接失败 - 将在 5000ms 后重试
[NotificationHub] 重连尝试 1/5...
[NotificationHub] SignalR 连接失败 - 将在 10000ms 后重试
...
```

#### 验证点：
- ✅ SignalR 连接失败后自动重试（最多 5 次）
- ✅ 降级轮询每 60 秒获取一次未读数
- ✅ Dock 仍然显示未读数（通过 API 轮询）
- ✅ 连接状态指示为离线或重连中

---

### 4. 断线重连测试

#### 步骤：
1. 确保所有服务运行
2. 登录系统，确认 SignalR 已连接
3. 停止 Gateway 服务
4. 等待 10 秒
5. 重新启动 Gateway 服务
```bash
cd /mnt/d/Code/Radish && dotnet run --project Radish.Gateway
```
6. 观察控制台

#### 预期结果：
```
[NotificationHub] SignalR 连接已关闭
[NotificationHub] 重连尝试 1/5...
[NotificationHub] SignalR 连接成功 - ConnectionId: xxx (新的连接ID)
[NotificationHub] 未读数更新: 0
```

#### 验证点：
- ✅ 断线后自动尝试重连
- ✅ 服务恢复后成功重新建立连接
- ✅ 重连后重新订阅事件，推送功能恢复
- ✅ UI 状态正确更新

---

### 5. React StrictMode 兼容性测试

#### 步骤：
1. 确认 `main.tsx` 中启用了 `<React.StrictMode>`
2. 打开控制台
3. 登录系统

#### 预期结果：
- ✅ 仅建立 **1 个** SignalR 连接
- ✅ 控制台没有 "重复连接" 警告
- ✅ 推送功能正常

#### 验证点：
- ✅ NotificationHub 使用 `requestId` 机制防止重复连接
- ✅ 组件卸载时正确清理连接

---

## 性能指标

### 推送延迟
- **目标**: < 1 秒
- **测试**: 调用 TestPushUnreadCount → Dock 显示新数字
- **测量**: 使用浏览器 DevTools Network 标签查看 WebSocket 帧时间

### 轮询频率
- **SignalR 连接成功**: 0 次/分钟（不轮询）
- **SignalR 连接失败**: 1 次/60秒（降级轮询）

### 连接稳定性
- **心跳间隔**: 15 秒
- **超时时间**: 30 秒
- **重连策略**: 指数退避，最多 5 次

---

## 常见问题

### 1. CORS 错误：Access to fetch... has been blocked by CORS policy
**原因**: Gateway 使用了 http profile 启动，导致前端（https://localhost:5000）访问 API 时协议不匹配
**症状**:
```
Access to fetch at 'http://localhost:5001/...' from origin 'https://localhost:5000'
has been blocked by CORS policy
```
**解决**:
```bash
# 必须使用 https profile 启动 Gateway
dotnet run --project Radish.Gateway --launch-profile https
```

### 2. SignalR start/stop 竞态错误
**原因**: useEffect 依赖数组包含 `connectionState`，导致状态变化时重启连接
**症状**:
```
[NotificationHub] 连接启动取消 (start/stop 竞态)
Error: Failed to start the HttpConnection before stop() was called.
```
**解决**: 已修复（Dock.tsx:239），依赖数组只包含 `loggedIn`，不包含 `connectionState`

### 3. SignalR 连接失败，提示 401 Unauthorized
**原因**: JWT Token 未正确传递
**解决**: 检查 localStorage 中是否有 `access_token`，确保已登录

### 4. 推送不生效
**检查清单**:
- [ ] Gateway 服务是否使用 https profile 运行
- [ ] 浏览器控制台是否显示 "SignalR 连接成功"
- [ ] NotificationPushService 是否正确注册（检查 Program.cs）
- [ ] 用户组是否正确加入（检查 NotificationHub.OnConnectedAsync）

### 5. 重复连接
**原因**: React StrictMode 导致
**解决**: 已通过 `requestId` 机制修复，无需操作

### 6. 未读数不更新
**检查**:
- 如果 SignalR 已连接，应显示 `storeUnreadCount`（从 Zustand store）
- 如果 SignalR 未连接，应显示 `pollingUnreadCount`（从 API 轮询）
- 检查 Dock.tsx 第 33 行逻辑：
  ```typescript
  const unreadMessages = connectionState === 'connected' ? storeUnreadCount : pollingUnreadCount;
  ```

---

## 测试完成标准

- [x] SignalR 连接在用户登录后自动建立
- [x] 未读数推送实时到达（< 1 秒）
- [x] 连接失败时降级为 60 秒轮询
- [x] 断线后自动重连（最多 5 次）
- [x] React StrictMode 下无重复连接
- [x] 推送测试 API 正常工作
- [x] 前端 TypeScript 编译无错误
- [x] 后端 .NET 构建无错误

---

## 下一步（P1 阶段）

P0 阶段重点是**替换轮询机制**，验证 SignalR 推送功能正常工作。

P1 阶段将实现完整的通知系统：
1. 创建通知数据模型（Notification 表）
2. 在业务逻辑中集成推送（评论、点赞、@提及）
3. 实现通知列表页面
4. 实现标记已读功能
5. 多端同步已读状态

---

## 测试日志

### 测试时间
- 开始: 2026-01-07 21:09
- 服务状态: ✅ Gateway, ✅ Auth, ✅ 前端

### 测试结果
待手动验证...

