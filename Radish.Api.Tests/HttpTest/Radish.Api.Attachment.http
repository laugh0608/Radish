###############################################################################
# Radish.Api - 附件管理 API 测试
###############################################################################
# 说明：
# 1. 本文件用于测试附件上传、下载、删除等功能
# 2. 需要先获取有效的 Access Token（从 Radish.Api.AuthFlow.http 获取）
# 3. 使用 REST Client 或 HTTP Client 插件运行测试
# 4. 文件上传需要准备测试图片/文档文件
###############################################################################

@Access_Token = eyJhbGciOiJSUzI1NiIsImtpZCI6IjgzMTVEQkQ1QTE1NkZDNUJGQUU4OEQ0QjA1RDAwM0VFNTAzQ0FGNTQiLCJ4NXQiOiJneFhiMWFGV19GdjY2STFMQmRBRDdsQThyMVEiLCJ0eXAiOiJhdCtqd3QifQ.eyJpc3MiOiJodHRwczovL2xvY2FsaG9zdDo1MDAwLyIsImV4cCI6MTc2NTU1MTE3MCwiaWF0IjoxNzY1NTQ3NTcwLCJhdWQiOiJyYWRpc2gtYXBpIiwic2NvcGUiOiJyYWRpc2gtYXBpIiwianRpIjoiY2QwNmZlYzAtZTdlNC00NWVkLWE1YjMtZTYyMDQ0YWFhNzE0IiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZWlkZW50aWZpZXIiOiIyMDAwMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJzeXN0ZW0iLCJzdWIiOiIyMDAwMCIsIm5hbWUiOiJzeXN0ZW0iLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJzeXN0ZW0iLCJ0ZW5hbnRfaWQiOiIzMDAwMCIsImdpdmVuX25hbWUiOiJTeXN0ZW0gVXNlciIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlN5c3RlbSIsInJvbGUiOiJTeXN0ZW0iLCJvaV9wcnN0IjoicmFkaXNoLWNsaWVudCIsIm9pX2F1X2lkIjoiOGNiYTBmNGMtNzBjOC00N2FlLWFjYjQtNjMzMzY3ZWJmMDZkIiwiY2xpZW50X2lkIjoicmFkaXNoLWNsaWVudCIsIm9pX3Rrbl9pZCI6ImVjYjAyYmFhLTgyM2QtNGM1NS05ZmM5LThhYzVkZjVjZjk4OSJ9.OB_xfuHLxR5ZLUp3VrL78GNz-67A9N9dDrC0NQWBngQlK_6jMNVQL3lNnk-uldY6Si_4V5ZZ34GYcrh88oGt5ZNQ4e0iIgu6FTPcRd1BEo2VdF-ebgPyNSAlXoWdvZLpNR3l2kwXjlUQR_CHe450KC0FPfRyyAHCUSrnQ9LUIaquOTFZSYlSD2ZHtxbG_lFfGi0sex_dKLc4Yn2J619o1zvPq3kC_GkXNvmkQTsWfPdh1VpyP3SrvT66r8I3w3OKciAqYXWu_58it0w-2nWL-UM9YhBqp4Hy7v8hMD-VIf4WPVnpEEEot5U4G0NzkijRzsrlZB59DFyBGCzB8qUB_A
@Gateway_HostAddress = https://localhost:5000
@Api_HostAddress = http://localhost:5100

# 测试变量（根据实际情况修改）
@AttachmentId = 1
@BusinessType = Post
@BusinessId = 70001

###############################################################################
# 1. 图片上传测试
###############################################################################

### 1.1 上传图片（基础）
# 注意：需要准备一个测试图片文件，修改文件路径
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="test-image.jpg"
Content-Type: image/jpeg

< ./test-files/test-image.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="generateThumbnail"

true
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="removeExif"

true
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 1.2 上传图片（指定业务类型为 Post）
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="post-image.png"
Content-Type: image/png

< ./test-files/test-image.png
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

Post
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="generateThumbnail"

true
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="removeExif"

true
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 1.3 上传头像图片（业务类型为 Avatar）
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="avatar.jpg"
Content-Type: image/jpeg

< ./test-files/avatar.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

Avatar
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="generateThumbnail"

true
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="removeExif"

true
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 1.4 上传图片（不生成缩略图）
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="no-thumbnail.jpg"
Content-Type: image/jpeg

< ./test-files/test-image.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="generateThumbnail"

false
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="removeExif"

false
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 1.5 上传图片（测试文件去重功能）
# 上传相同的文件，应该返回已存在的附件记录
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="duplicate-test.jpg"
Content-Type: image/jpeg

< ./test-files/test-image.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="generateThumbnail"

true
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="removeExif"

true
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###############################################################################
# 2. 文档上传测试
###############################################################################

### 2.1 上传 PDF 文档
POST {{Api_HostAddress}}/api/v1/Attachment/UploadDocument
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="test-document.pdf"
Content-Type: application/pdf

< ./test-files/test-document.pdf
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

Document
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 2.2 上传 Markdown 文档
POST {{Api_HostAddress}}/api/v1/Attachment/UploadDocument
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="test-document.md"
Content-Type: text/markdown

< ./test-files/test-document.md
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

Document
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 2.3 上传 Excel 文档
POST {{Api_HostAddress}}/api/v1/Attachment/UploadDocument
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="test-spreadsheet.xlsx"
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet

< ./test-files/test-spreadsheet.xlsx
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

Document
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###############################################################################
# 3. 附件查询测试
###############################################################################

### 3.1 根据 ID 获取附件信息
GET {{Api_HostAddress}}/api/v1/Attachment/GetById/{{AttachmentId}}
Accept: application/json

### 3.2 根据业务类型和业务 ID 获取附件列表
GET {{Api_HostAddress}}/api/v1/Attachment/GetByBusiness?businessType={{BusinessType}}&businessId={{BusinessId}}
Accept: application/json

### 3.3 获取指定 Post 的所有附件
GET {{Api_HostAddress}}/api/v1/Attachment/GetByBusiness?businessType=Post&businessId=70001
Accept: application/json

### 3.4 获取指定 Comment 的所有附件
GET {{Api_HostAddress}}/api/v1/Attachment/GetByBusiness?businessType=Comment&businessId=90001
Accept: application/json

###############################################################################
# 4. 附件下载测试
###############################################################################

### 4.1 下载指定附件
# 注意：这个请求会返回文件流，浏览器会自动下载
GET {{Api_HostAddress}}/api/v1/Attachment/Download/{{AttachmentId}}

### 4.2 直接访问上传的文件（通过静态文件路径）
# 例如：http://localhost:5100/uploads/General/2025/12/1234567890.jpg
# 需要根据上传后返回的 URL 进行访问
GET {{Api_HostAddress}}/uploads/General/2025/12/1234567890.jpg

### 4.3 访问缩略图
# 例如：http://localhost:5100/uploads/General/2025/12/1234567890_thumb.jpg
GET {{Api_HostAddress}}/uploads/General/2025/12/1234567890_thumb.jpg

###############################################################################
# 5. 附件更新测试
###############################################################################

### 5.1 更新附件的业务关联
# 将附件关联到指定的业务对象（例如将临时上传的图片关联到发布的帖子）
PUT {{Api_HostAddress}}/api/v1/Attachment/UpdateBusinessAssociation/{{AttachmentId}}?businessType=Post&businessId=70001
Authorization: Bearer {{Access_Token}}
Content-Type: application/json

### 5.2 更新附件关联到 Comment
PUT {{Api_HostAddress}}/api/v1/Attachment/UpdateBusinessAssociation/{{AttachmentId}}?businessType=Comment&businessId=90001
Authorization: Bearer {{Access_Token}}
Content-Type: application/json

###############################################################################
# 6. 附件删除测试
###############################################################################

### 6.1 删除单个附件
# 只有上传者或管理员可以删除
DELETE {{Api_HostAddress}}/api/v1/Attachment/Delete/{{AttachmentId}}
Authorization: Bearer {{Access_Token}}

### 6.2 批量删除附件
POST {{Api_HostAddress}}/api/v1/Attachment/DeleteBatch
Authorization: Bearer {{Access_Token}}
Content-Type: application/json

[1, 2, 3, 4, 5]

### 6.3 删除指定 ID 的附件（需要替换为实际的附件 ID）
DELETE {{Api_HostAddress}}/api/v1/Attachment/Delete/1234567890
Authorization: Bearer {{Access_Token}}

###############################################################################
# 7. 错误场景测试
###############################################################################

### 7.1 上传空文件（应返回 400 错误）
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 7.2 上传不支持的文件类型（应返回 400 错误）
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="test.exe"
Content-Type: application/octet-stream

< ./test-files/test.exe
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 7.3 未认证时上传文件（应返回 401 错误）
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="test-image.jpg"
Content-Type: image/jpeg

< ./test-files/test-image.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 7.4 删除不存在的附件（应返回 404 错误）
DELETE {{Api_HostAddress}}/api/v1/Attachment/Delete/999999999
Authorization: Bearer {{Access_Token}}

### 7.5 下载不存在的附件（应返回 404 错误）
GET {{Api_HostAddress}}/api/v1/Attachment/Download/999999999

### 7.6 普通用户删除别人的附件（应返回 403 错误）
# 需要先用普通用户的 Token（非 System/Admin）
DELETE {{Api_HostAddress}}/api/v1/Attachment/Delete/{{AttachmentId}}
Authorization: Bearer <普通用户的Token>

###############################################################################
# 8. 文件大小限制测试
###############################################################################

### 8.1 上传超大文件（超过 100MB，应返回 400 错误）
# 注意：需要准备一个超过 100MB 的文件
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="large-file.jpg"
Content-Type: image/jpeg

< ./test-files/large-file.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###############################################################################
# 9. 文件头校验测试（Magic Number）
###############################################################################

### 9.1 上传伪装的图片文件（文本文件改扩展名为 .jpg，应返回 400 错误）
# 测试 Magic Number 检查是否生效
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="fake-image.jpg"
Content-Type: image/jpeg

< ./test-files/fake-image.jpg
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 9.2 上传伪装的 PDF 文件（HTML 文件改扩展名为 .pdf，应返回 400 错误）
POST {{Api_HostAddress}}/api/v1/Attachment/UploadDocument
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="fake-document.pdf"
Content-Type: application/pdf

< ./test-files/fake-document.pdf
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

Document
------WebKitFormBoundary7MA4YWxkTrZu0gW--

### 9.3 上传真实的 PNG 文件但声称是 JPG（应通过，因为都是图片）
# 注意：这个测试应该成功，因为 PNG 和 JPG 都是允许的图片格式
POST {{Api_HostAddress}}/api/v1/Attachment/UploadImage
Authorization: Bearer {{Access_Token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="real-png-as-jpg.jpg"
Content-Type: image/jpeg

< ./test-files/test-image.png
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="businessType"

General
------WebKitFormBoundary7MA4YWxkTrZu0gW--

###############################################################################
# 测试说明
###############################################################################
#
# 1. 测试前准备：
#    - 在 HttpTest/test-files/ 目录下准备测试文件
#    - 从 Radish.Api.AuthFlow.http 获取有效的 Access_Token
#    - 确保 API 服务已启动（dotnet run --project Radish.Api）
#
# 2. 测试文件准备：
#    mkdir -p HttpTest/test-files
#    - test-image.jpg (任意 JPG 图片，小于 100MB)
#    - test-image.png (任意 PNG 图片)
#    - avatar.jpg (头像测试图片)
#    - test-document.pdf (任意 PDF 文件)
#    - test-document.md (任意 Markdown 文件)
#    - test-spreadsheet.xlsx (任意 Excel 文件)
#
# 3. 测试流程：
#    a. 上传测试：1.1 → 1.2 → 1.5 (测试去重) → 2.1 → 2.2
#    b. 查询测试：3.1 → 3.2 → 3.3
#    c. 下载测试：4.1 → 4.2 → 4.3
#    d. 更新测试：5.1 → 5.2
#    e. 删除测试：6.1 → 6.2
#    f. 错误测试：7.1 → 7.2 → 7.3 → 7.4 → 7.5 → 7.6
#    g. 大文件测试：8.1
#
# 4. 预期结果：
#    - 上传成功返回 200，包含附件信息（ID、URL、文件大小等）
#    - 去重上传返回已存在的附件记录
#    - 查询返回附件详情或列表
#    - 下载返回文件流
#    - 更新成功返回 200
#    - 删除成功返回 200
#    - 错误场景返回对应的错误码（400/401/403/404）
#
# 5. 验证要点：
#    - 文件是否正确保存到 uploads 目录
#    - 缩略图是否正确生成（_thumb 文件）
#    - 文件去重功能是否生效（相同文件不重复存储）
#    - 权限控制是否正确（只有上传者/管理员可以删除）
#    - 错误提示是否清晰友好
#
###############################################################################
